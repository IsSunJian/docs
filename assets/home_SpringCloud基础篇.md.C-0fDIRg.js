import{_ as a,c as s,o as n,a4 as p}from"./chunks/framework.-JfgED0h.js";const e="/docs/assets/image-20220530100215482.DecrqTqN.png",l="/docs/assets/image-20220530105109960.C0MAjZ8Z.png",t="/docs/assets/image-20220530105724299.DIaGXMan.png",i="/docs/assets/image-20220530111746006.B5-itK7G.png",o="/docs/assets/image-20220530112133529.BP0sTZNt.png",c="/docs/assets/image-20220530114202433.Bo8x0nf5.png",r="/docs/assets/image-20220530115322559.CEGDI35y.png",d="/docs/assets/image-20220530115412871.BIWKLJam.png",g="/docs/assets/image-20220530115830236.BWnVWj0Y.png",u="/docs/assets/image-20220530124325327.73CcXYMV.png",h="/docs/assets/image-20220530124529043.DY5haZD4.png",m="/docs/assets/image-20220530124832871.UApKA0cw.png",b="/docs/assets/image-20220530124944397.BQ6m39Ax.png",E="/docs/assets/image-20220530125210051.DaBTICU_.png",_="/docs/assets/image-20220530125307680.DSxB08c6.png",f="/docs/assets/image-20220530125413399.Bn4hBq3Z.png",v="/docs/assets/image-20220530131342656.BQTM_6td.png",T="/docs/assets/image-20220530131452541.BFrYjqzE.png",N="/docs/assets/image-20220530132154040.BJLm3F5e.png",L="data:image/png;base64,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",C="/docs/assets/image-20220530133705187.BeU59KpF.png",M="/docs/assets/image-20220530164329834.BJdjL15S.png",U="/docs/assets/image-20220530164446935.DQELHxCW.png",k="/docs/assets/image-20220530164620291.D-jGeQYm.png",y="/docs/assets/image-20220530165024880.C-f7uS-V.png",A="/docs/assets/image-20220530182615744.Cys9ZjfJ.png",q="/docs/assets/image-20220530182926286.BkA4xLeC.png",O="/docs/assets/image-20220530183429549.CYiwUhKt.png",F="/docs/assets/2022_05_30_18_36_22_320.DKi-yN9x.gif",x="/docs/assets/image-20220530184057390.C3LJr1nY.png",I="/docs/assets/image-20220530185037958.DMk2X5AN.png",R="/docs/assets/image-20220530185323725.CMI2coU1.png",P="/docs/assets/image-20220530191022084.iFnF4V3Q.png",V=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"home/SpringCloud基础篇.md","filePath":"home/SpringCloud基础篇.md"}'),D={name:"home/SpringCloud基础篇.md"},S=p('<h2 id="一、nacos配置管理" tabindex="-1">一、Nacos配置管理 <a class="header-anchor" href="#一、nacos配置管理" aria-label="Permalink to &quot;一、Nacos配置管理&quot;">​</a></h2><p>Nacos除了可以做注册中心，同样可以做配置管理来使用。</p><h2 id="_1-统一配置管理" tabindex="-1">1.统一配置管理 <a class="header-anchor" href="#_1-统一配置管理" aria-label="Permalink to &quot;1.统一配置管理&quot;">​</a></h2><blockquote><p>当微服务部署的实例越来越多，达到数十、数百时，逐个修改微服务配置就会让人抓狂，而且很容易出错。<strong>我们需要一种统一配置管理方案，可以集中管理所有实例的配置。</strong></p></blockquote><p><img src="'+e+'" alt="image-20220530100215482"></p><p>Nacos一方面可以将配置集中管理，另一方可以在配置变更时，及时通知微服务，<strong>实现配置的热更新</strong>。</p><h3 id="_1-1-创建配置" tabindex="-1">1.1 创建配置 <a class="header-anchor" href="#_1-1-创建配置" aria-label="Permalink to &quot;1.1 创建配置&quot;">​</a></h3><hr><ul><li><p><strong>在 <code>Nacos</code> 控制面板中添加配置文件</strong></p><p><img src="'+l+'" alt="image-20220530105109960"></p></li><li><p><strong>然后在弹出的表单中，填写配置信息</strong></p><p><img src="'+t+'" alt="image-20220530105724299"></p></li></ul><p><strong><strong>注意：项目的核心配置，需要热更新的配置才有放到 nacos 管理的必要。基本不会变更的一些配置（例如数据库连接）还是保存在微服务本地比较好。</strong></strong></p><h3 id="_1-2-拉取配置" tabindex="-1">1.2 拉取配置 <a class="header-anchor" href="#_1-2-拉取配置" aria-label="Permalink to &quot;1.2 拉取配置&quot;">​</a></h3><hr><blockquote><p>读取配置文件的流程图</p></blockquote><ul><li><p><strong>首先我们需要了解 <code>Nacos</code> 读取配置文件的环节是在哪一步，在没加入 <code>Nacos</code> 配置之前，获取配置是这样</strong></p><p><img src="'+i+'" alt="image-20220530111746006"></p></li><li><p><strong>加入 <code>Nacos</code> 配置，它的读取是在 <code>application.yml</code> 之前的</strong></p><p><img src="'+o+`" alt="image-20220530112133529"></p><p><strong>但如果尚未读取application.yml，又如何得知nacos地址呢？</strong></p><p><strong>因此spring引入了一种新的配置文件：bootstrap.yaml文件，会在application.yml之前被读取。</strong></p></li></ul><blockquote><p>代码中读取配置文件</p></blockquote><ul><li><p><strong>在 <code>user-service</code> 中引入 nacos-config 依赖</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;!--nacos配置管理依赖--&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li><li><p><strong>在 <code>user-service</code> 中添加一个 <code>bootstrap.yml</code> 文件</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring:</span></span>
<span class="line"><span>  application:</span></span>
<span class="line"><span>    name: userservice # 服务名称</span></span>
<span class="line"><span>  profiles:</span></span>
<span class="line"><span>    active: dev #开发环境，这里是dev</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    nacos:</span></span>
<span class="line"><span>      server-addr: localhost:8848 # Nacos地址</span></span>
<span class="line"><span>      config:</span></span>
<span class="line"><span>        file-extension: yaml # 文件后缀名</span></span>
<span class="line"><span>yml</span></span></code></pre></div><p><img src="`+c+`" alt="image-20220530114202433"></p></li><li><p><strong>在 <code>user-service</code> 中的 <code>UserController</code> 中添加业务逻辑，读取 <code>pattern.dateformat</code> 配置并使用</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@Value(&quot;\${pattern.dateformat}&quot;)</span></span>
<span class="line"><span>private String dateformat;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@GetMapping(&quot;now&quot;)</span></span>
<span class="line"><span>public String now(){</span></span>
<span class="line"><span>    //格式化时间</span></span>
<span class="line"><span>    return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div><p><img src="`+r+'" alt="image-20220530115322559"></p></li><li><p><strong>在页面访问<a href="http://localhost:8081/user/now%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E6%95%88%E6%9E%9C" target="_blank" rel="noreferrer">http://localhost:8081/user/now，可以看到效果</a></strong></p><p><img src="'+d+'" alt="image-20220530115412871"></p></li></ul><h3 id="_1-3-流程总结" tabindex="-1">1.3 流程总结 <a class="header-anchor" href="#_1-3-流程总结" aria-label="Permalink to &quot;1.3 流程总结&quot;">​</a></h3><hr><ul><li>在Nacos中添加配置文件</li><li>在微服务中引入nacos的config依赖</li><li>在微服务中添加bootstrap.yml，配置nacos地址、当前环境、服务名称、文件后缀名。这些决定了程序启动时去nacos读取哪个文件</li></ul><h2 id="_2-配置热更新" tabindex="-1">2.配置热更新 <a class="header-anchor" href="#_2-配置热更新" aria-label="Permalink to &quot;2.配置热更新&quot;">​</a></h2><blockquote><p>我们最终的目的，是修改 nacos 中的配置后，微服务中无需重启即可让配置生效，也就是<strong>配置热更新</strong>。</p></blockquote><p>有两种方式：</p><ol><li>用 <code>@value</code> 读取配置时，搭配 <code>@RefreshScope</code>；</li><li>直接用 <code>@ConfigurationProperties</code> 读取配置</li></ol><h3 id="_2-1-方式1-refreshscope" tabindex="-1">2.1 方式1：@RefreshScope <a class="header-anchor" href="#_2-1-方式1-refreshscope" aria-label="Permalink to &quot;2.1 方式1：@RefreshScope&quot;">​</a></h3><hr><ul><li><p>在 <code>@Value</code> 注入的变量所在类上添加注解 <code>@RefreshScope</code></p><p><img src="'+g+`" alt="image-20220530115830236"></p></li></ul><h3 id="_2-2-方式2-configurationproperties" tabindex="-1">2.2 方式2：ConfigurationProperties <a class="header-anchor" href="#_2-2-方式2-configurationproperties" aria-label="Permalink to &quot;2.2 方式2：ConfigurationProperties&quot;">​</a></h3><hr><ul><li><p>使用 <code>@ConfigurationProperties</code> 注解读取配置文件，就不需要加 <code>@RefreshScope</code> 注解</p></li><li><p>在 user-service 服务中，添加一个 PatternProperties 类，读取 <code>patterrn.dateformat</code> 属性</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@Data</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>@ConfigurationProperties(prefix = &quot;pattern&quot;)</span></span>
<span class="line"><span>public class PatternProperties {</span></span>
<span class="line"><span>    public String dateFormat;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@Autowired</span></span>
<span class="line"><span>private PatternProperties properties;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@GetMapping(&quot;/now&quot;)</span></span>
<span class="line"><span>public String now(){</span></span>
<span class="line"><span>    //格式化时间</span></span>
<span class="line"><span>    return LocalDateTime.now().format(DateTimeFormatter.ofPattern(properties.getDateFormat()));</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul><h2 id="_3-配置共享" tabindex="-1">3.配置共享 <a class="header-anchor" href="#_3-配置共享" aria-label="Permalink to &quot;3.配置共享&quot;">​</a></h2><p>其实微服务启动时，会去nacos读取多个配置文件，例如：</p><ul><li><code>[spring.application.name]-[spring.profiles.active].yaml</code>，例如：userservice-dev.yaml</li><li><code>[spring.application.name].yaml</code>，例如：userservice.yaml</li></ul><p>而<code>[spring.application.name].yaml</code>不包含环境，因此可以被多个环境共享。</p><p>下面我们通过案例来测试配置共享</p><h3 id="_3-1-添加一个环境共享配置" tabindex="-1">3.1 添加一个环境共享配置 <a class="header-anchor" href="#_3-1-添加一个环境共享配置" aria-label="Permalink to &quot;3.1 添加一个环境共享配置&quot;">​</a></h3><hr><ul><li><p><strong>我们在 <code>nacos</code> 中添加一个 <code>userservice.yaml</code> 文件</strong></p><p><img src="`+u+'" alt="image-20220530124325327"></p></li><li><p><strong>在<code>user-service</code>服务中，修改<code>PatternProperties</code>类，读取新添加的属性</strong></p><p><img src="'+h+`" alt="image-20220530124529043"></p></li><li><p><strong>在 <code>user-service</code> 服务中，修改 <code>UserController</code>，添加一个方法</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;prop&quot;)</span></span>
<span class="line"><span>public PatternProperties prop(){</span></span>
<span class="line"><span>    return properties;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p><strong>运行两个 <code>UserApplication</code>，使用不同的profile</strong></p><p>修改UserApplication2这个启动项，改变其profile值</p><p><img src="`+m+'" alt="image-20220530124832871"></p><p><img src="'+b+'" alt="image-20220530124944397"></p><p>这时候，<code>UserApplication(8081)</code> 使用的 <code>profile</code> 是 <code>dev</code>，<code>UserApplication2(8082)</code> 使用的 <code>profile</code> 是<code>test</code></p></li><li><p><strong>访问<a href="http://localhost:8081/user/prop" target="_blank" rel="noreferrer">http://localhost:8081/user/prop</a></strong></p><p><img src="'+E+'" alt="image-20220530125210051"></p></li><li><p><strong>访问<a href="http://localhost:8082/user/prop" target="_blank" rel="noreferrer">http://localhost:8082/user/prop</a></strong></p><p><img src="'+_+'" alt="image-20220530125307680"></p></li></ul><p><strong>可以看出来，不管是dev，还是test环境，都读取到了envSharedValue这个属性的值。</strong></p><h2 id="_4-配置共享的优先级" tabindex="-1">4.配置共享的优先级 <a class="header-anchor" href="#_4-配置共享的优先级" aria-label="Permalink to &quot;4.配置共享的优先级&quot;">​</a></h2><blockquote><p>当nacos、服务本地同时出现相同属性时，优先级有高低之分</p></blockquote><p><img src="'+f+'" alt="image-20220530125413399"></p><p><strong>[服务名]-[环境].yaml &gt;[服务名].yaml &gt; 本地配置</strong></p><h2 id="_5-nacos集群" tabindex="-1">5.Nacos集群 <a class="header-anchor" href="#_5-nacos集群" aria-label="Permalink to &quot;5.Nacos集群&quot;">​</a></h2><p>Nacos生产环境下一定要部署为集群状态</p><h3 id="_5-1-集群结构图" tabindex="-1">5.1 集群结构图 <a class="header-anchor" href="#_5-1-集群结构图" aria-label="Permalink to &quot;5.1 集群结构图&quot;">​</a></h3><hr><ul><li><p><strong>官方给出的Nacos集群图</strong></p><p>其中包含3个nacos节点，然后一个负载均衡器代理3个Nacos。这里负载均衡器可以使用nginx</p><p><img src="'+v+'" alt="image-20220530131342656"></p></li><li><p><strong>我们计划的集群结构</strong></p><p><img src="'+T+'" alt="image-20220530131452541"></p></li><li><p><strong>三个nacos节点的地址</strong></p><table><thead><tr><th>节点</th><th>ip</th><th>port</th></tr></thead><tbody><tr><td>nacos1</td><td>192.168.150.1</td><td>8845</td></tr><tr><td>nacos2</td><td>192.168.150.1</td><td>8846</td></tr><tr><td>nacos3</td><td>192.168.150.1</td><td>8847</td></tr></tbody></table></li></ul><h3 id="_5-2-搭建集群" tabindex="-1">5.2 搭建集群 <a class="header-anchor" href="#_5-2-搭建集群" aria-label="Permalink to &quot;5.2 搭建集群&quot;">​</a></h3><hr><p>搭建集群的基本步骤：</p><ul><li>搭建数据库，初始化数据库表结构</li><li>下载nacos安装包</li><li>配置nacos</li><li>启动nacos集群</li><li>nginx反向代理</li></ul><blockquote><p>本次演示以windows系统下搭建</p></blockquote><h4 id="_1-初始化数据库" tabindex="-1">1&gt; 初始化数据库 <a class="header-anchor" href="#_1-初始化数据库" aria-label="Permalink to &quot;1&gt; 初始化数据库&quot;">​</a></h4><hr><p>Nacos 默认数据存储在内嵌数据库 Derby 中，不属于生产可用的数据库。官方推荐的最佳实践是使用带有主从的高可用数据库集群，主从模式的高可用数据库。这里我们以单点的数据库为例。</p><p>首先新建一个数据库，命名为 nacos，而后导入下面的 SQL</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>CREATE TABLE `config_info` (</span></span>\n<span class="line"><span>  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span></span>\n<span class="line"><span>  `data_id` varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span></span>\n<span class="line"><span>  `group_id` varchar(255) DEFAULT NULL,</span></span>\n<span class="line"><span>  `content` longtext NOT NULL COMMENT &#39;content&#39;,</span></span>\n<span class="line"><span>  `md5` varchar(32) DEFAULT NULL COMMENT &#39;md5&#39;,</span></span>\n<span class="line"><span>  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  `src_user` text COMMENT &#39;source user&#39;,</span></span>\n<span class="line"><span>  `src_ip` varchar(50) DEFAULT NULL COMMENT &#39;source ip&#39;,</span></span>\n<span class="line"><span>  `app_name` varchar(128) DEFAULT NULL,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span></span>\n<span class="line"><span>  `c_desc` varchar(256) DEFAULT NULL,</span></span>\n<span class="line"><span>  `c_use` varchar(64) DEFAULT NULL,</span></span>\n<span class="line"><span>  `effect` varchar(64) DEFAULT NULL,</span></span>\n<span class="line"><span>  `type` varchar(64) DEFAULT NULL,</span></span>\n<span class="line"><span>  `c_schema` text,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;config_info&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = config_info_aggr   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `config_info_aggr` (</span></span>\n<span class="line"><span>  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span></span>\n<span class="line"><span>  `data_id` varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span></span>\n<span class="line"><span>  `group_id` varchar(255) NOT NULL COMMENT &#39;group_id&#39;,</span></span>\n<span class="line"><span>  `datum_id` varchar(255) NOT NULL COMMENT &#39;datum_id&#39;,</span></span>\n<span class="line"><span>  `content` longtext NOT NULL COMMENT &#39;内容&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  `app_name` varchar(128) DEFAULT NULL,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;增加租户字段&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = config_info_beta   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `config_info_beta` (</span></span>\n<span class="line"><span>  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span></span>\n<span class="line"><span>  `data_id` varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span></span>\n<span class="line"><span>  `group_id` varchar(128) NOT NULL COMMENT &#39;group_id&#39;,</span></span>\n<span class="line"><span>  `app_name` varchar(128) DEFAULT NULL COMMENT &#39;app_name&#39;,</span></span>\n<span class="line"><span>  `content` longtext NOT NULL COMMENT &#39;content&#39;,</span></span>\n<span class="line"><span>  `beta_ips` varchar(1024) DEFAULT NULL COMMENT &#39;betaIps&#39;,</span></span>\n<span class="line"><span>  `md5` varchar(32) DEFAULT NULL COMMENT &#39;md5&#39;,</span></span>\n<span class="line"><span>  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  `src_user` text COMMENT &#39;source user&#39;,</span></span>\n<span class="line"><span>  `src_ip` varchar(50) DEFAULT NULL COMMENT &#39;source ip&#39;,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;config_info_beta&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = config_info_tag   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `config_info_tag` (</span></span>\n<span class="line"><span>  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span></span>\n<span class="line"><span>  `data_id` varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span></span>\n<span class="line"><span>  `group_id` varchar(128) NOT NULL COMMENT &#39;group_id&#39;,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) DEFAULT &#39;&#39; COMMENT &#39;tenant_id&#39;,</span></span>\n<span class="line"><span>  `tag_id` varchar(128) NOT NULL COMMENT &#39;tag_id&#39;,</span></span>\n<span class="line"><span>  `app_name` varchar(128) DEFAULT NULL COMMENT &#39;app_name&#39;,</span></span>\n<span class="line"><span>  `content` longtext NOT NULL COMMENT &#39;content&#39;,</span></span>\n<span class="line"><span>  `md5` varchar(32) DEFAULT NULL COMMENT &#39;md5&#39;,</span></span>\n<span class="line"><span>  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  `src_user` text COMMENT &#39;source user&#39;,</span></span>\n<span class="line"><span>  `src_ip` varchar(50) DEFAULT NULL COMMENT &#39;source ip&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;config_info_tag&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = config_tags_relation   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `config_tags_relation` (</span></span>\n<span class="line"><span>  `id` bigint(20) NOT NULL COMMENT &#39;id&#39;,</span></span>\n<span class="line"><span>  `tag_name` varchar(128) NOT NULL COMMENT &#39;tag_name&#39;,</span></span>\n<span class="line"><span>  `tag_type` varchar(64) DEFAULT NULL COMMENT &#39;tag_type&#39;,</span></span>\n<span class="line"><span>  `data_id` varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span></span>\n<span class="line"><span>  `group_id` varchar(128) NOT NULL COMMENT &#39;group_id&#39;,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) DEFAULT &#39;&#39; COMMENT &#39;tenant_id&#39;,</span></span>\n<span class="line"><span>  `nid` bigint(20) NOT NULL AUTO_INCREMENT,</span></span>\n<span class="line"><span>  PRIMARY KEY (`nid`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span></span>\n<span class="line"><span>  KEY `idx_tenant_id` (`tenant_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;config_tag_relation&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = group_capacity   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `group_capacity` (</span></span>\n<span class="line"><span>  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,</span></span>\n<span class="line"><span>  `group_id` varchar(128) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;Group ID，空字符表示整个集群&#39;,</span></span>\n<span class="line"><span>  `quota` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;配额，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `usage` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;使用量&#39;,</span></span>\n<span class="line"><span>  `max_size` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个配置大小上限，单位为字节，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;聚合子配置最大个数，，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最大变更历史数量&#39;,</span></span>\n<span class="line"><span>  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_group_id` (`group_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;集群、各Group容量信息表&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = his_config_info   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `his_config_info` (</span></span>\n<span class="line"><span>  `id` bigint(64) unsigned NOT NULL,</span></span>\n<span class="line"><span>  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span></span>\n<span class="line"><span>  `data_id` varchar(255) NOT NULL,</span></span>\n<span class="line"><span>  `group_id` varchar(128) NOT NULL,</span></span>\n<span class="line"><span>  `app_name` varchar(128) DEFAULT NULL COMMENT &#39;app_name&#39;,</span></span>\n<span class="line"><span>  `content` longtext NOT NULL,</span></span>\n<span class="line"><span>  `md5` varchar(32) DEFAULT NULL,</span></span>\n<span class="line"><span>  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span></span>\n<span class="line"><span>  `src_user` text,</span></span>\n<span class="line"><span>  `src_ip` varchar(50) DEFAULT NULL,</span></span>\n<span class="line"><span>  `op_type` char(10) DEFAULT NULL,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`nid`),</span></span>\n<span class="line"><span>  KEY `idx_gmt_create` (`gmt_create`),</span></span>\n<span class="line"><span>  KEY `idx_gmt_modified` (`gmt_modified`),</span></span>\n<span class="line"><span>  KEY `idx_did` (`data_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;多租户改造&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>/*   数据库全名 = nacos_config   */</span></span>\n<span class="line"><span>/*   表名称 = tenant_capacity   */</span></span>\n<span class="line"><span>/******************************************/</span></span>\n<span class="line"><span>CREATE TABLE `tenant_capacity` (</span></span>\n<span class="line"><span>  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;Tenant ID&#39;,</span></span>\n<span class="line"><span>  `quota` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;配额，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `usage` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;使用量&#39;,</span></span>\n<span class="line"><span>  `max_size` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个配置大小上限，单位为字节，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;聚合子配置最大个数&#39;,</span></span>\n<span class="line"><span>  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#39;,</span></span>\n<span class="line"><span>  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最大变更历史数量&#39;,</span></span>\n<span class="line"><span>  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;租户容量信息表&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>CREATE TABLE `tenant_info` (</span></span>\n<span class="line"><span>  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span></span>\n<span class="line"><span>  `kp` varchar(128) NOT NULL COMMENT &#39;kp&#39;,</span></span>\n<span class="line"><span>  `tenant_id` varchar(128) default &#39;&#39; COMMENT &#39;tenant_id&#39;,</span></span>\n<span class="line"><span>  `tenant_name` varchar(128) default &#39;&#39; COMMENT &#39;tenant_name&#39;,</span></span>\n<span class="line"><span>  `tenant_desc` varchar(256) DEFAULT NULL COMMENT &#39;tenant_desc&#39;,</span></span>\n<span class="line"><span>  `create_source` varchar(32) DEFAULT NULL COMMENT &#39;create_source&#39;,</span></span>\n<span class="line"><span>  `gmt_create` bigint(20) NOT NULL COMMENT &#39;创建时间&#39;,</span></span>\n<span class="line"><span>  `gmt_modified` bigint(20) NOT NULL COMMENT &#39;修改时间&#39;,</span></span>\n<span class="line"><span>  PRIMARY KEY (`id`),</span></span>\n<span class="line"><span>  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span></span>\n<span class="line"><span>  KEY `idx_tenant_id` (`tenant_id`)</span></span>\n<span class="line"><span>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#39;tenant_info&#39;;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>CREATE TABLE `users` (</span></span>\n<span class="line"><span>`username` varchar(50) NOT NULL PRIMARY KEY,</span></span>\n<span class="line"><span>`password` varchar(500) NOT NULL,</span></span>\n<span class="line"><span>`enabled` boolean NOT NULL</span></span>\n<span class="line"><span>);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>CREATE TABLE `roles` (</span></span>\n<span class="line"><span>`username` varchar(50) NOT NULL,</span></span>\n<span class="line"><span>`role` varchar(50) NOT NULL,</span></span>\n<span class="line"><span>UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE</span></span>\n<span class="line"><span>);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>CREATE TABLE `permissions` (</span></span>\n<span class="line"><span>    `role` varchar(50) NOT NULL,</span></span>\n<span class="line"><span>    `resource` varchar(255) NOT NULL,</span></span>\n<span class="line"><span>    `action` varchar(8) NOT NULL,</span></span>\n<span class="line"><span>    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE</span></span>\n<span class="line"><span>);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>INSERT INTO users (username, password, enabled) VALUES (&#39;nacos&#39;, &#39;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#39;, TRUE);</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span>INSERT INTO roles (username, role) VALUES (&#39;nacos&#39;, &#39;ROLE_ADMIN&#39;);</span></span>\n<span class="line"><span>sql</span></span></code></pre></div><h4 id="_2-配置nacos" tabindex="-1">2&gt; 配置Nacos <a class="header-anchor" href="#_2-配置nacos" aria-label="Permalink to &quot;2&gt; 配置Nacos&quot;">​</a></h4><hr><ul><li><p><strong>进入 <code>nacos</code> 的 <code>conf</code> 目录，修改配置文件 <code>cluster.conf.example</code>，重命名为 <code>cluster.conf</code></strong></p><p><img src="'+N+`" alt="image-20220530132154040"></p></li><li><p><strong>添加内容</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>127.0.0.1:8845</span></span>
<span class="line"><span>127.0.0.1:8846</span></span>
<span class="line"><span>127.0.0.1:8847</span></span>
<span class="line"><span>tex</span></span></code></pre></div></li><li><p><strong>然后修改 <code>application.properties</code> 文件，添加数据库配置</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring.datasource.platform=mysql</span></span>
<span class="line"><span>db.num=1</span></span>
<span class="line"><span>db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span>
<span class="line"><span>db.user.0=root</span></span>
<span class="line"><span>db.password.0=123456</span></span>
<span class="line"><span>properties</span></span></code></pre></div></li><li><p><strong>将 nacos 文件夹复制三份，分别命名为：<code>nacos1</code>、<code>nacos2</code>、<code>nacos3</code></strong></p><p><img src="`+L+`" alt="image-20220530132541726"></p></li><li><p><strong>然后分别修改三个文件夹中的 <code>application.properties</code></strong></p><p>nacos1</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>server.port=8845</span></span>
<span class="line"><span>properties</span></span></code></pre></div><p>nacos2</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>server.port=8846</span></span>
<span class="line"><span>properties</span></span></code></pre></div><p>nacos3</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>server.port=8847</span></span>
<span class="line"><span>properties</span></span></code></pre></div></li><li><p><strong>然后分别启动三个<code>nacos</code>节点</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>startup.cmd</span></span>
<span class="line"><span>sh</span></span></code></pre></div></li></ul><h4 id="_3-nginx反向代理" tabindex="-1">3&gt; Nginx反向代理 <a class="header-anchor" href="#_3-nginx反向代理" aria-label="Permalink to &quot;3&gt; Nginx反向代理&quot;">​</a></h4><hr><ul><li><p><strong>修改 <code>nginx</code> 文件夹下的 <code>conf/nginx.conf</code> 文件，配置如下</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>worker_processes  1;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>events {</span></span>
<span class="line"><span>    worker_connections  1024;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>http {</span></span>
<span class="line"><span>    include       mime.types;</span></span>
<span class="line"><span>    default_type  application/octet-stream;</span></span>
<span class="line"><span>    sendfile        on;</span></span>
<span class="line"><span>    keepalive_timeout  65;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>upstream nacos-cluster {</span></span>
<span class="line"><span>server 127.0.0.1:8845;</span></span>
<span class="line"><span>server 127.0.0.1:8846;</span></span>
<span class="line"><span>server 127.0.0.1:8847;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>listen       80;</span></span>
<span class="line"><span>server_name  localhost;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>location /nacos {</span></span>
<span class="line"><span>proxy_pass http://nacos-cluster;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>nginx</span></span></code></pre></div></li><li><p><strong>启动 nginx，在浏览器访问：<a href="http://localhost/nacos" target="_blank" rel="noreferrer">http://localhost/nacos</a></strong></p><p><img src="`+C+`" alt="image-20220530133705187"></p></li></ul><h4 id="_4-修改application-yml" tabindex="-1">4&gt; 修改application.yml <a class="header-anchor" href="#_4-修改application-yml" aria-label="Permalink to &quot;4&gt; 修改application.yml&quot;">​</a></h4><hr><ul><li><p><strong>在代码中的 <code>application.yml</code> 文件配置改为如下</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring:</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    nacos:</span></span>
<span class="line"><span>      server-addr: localhost:80 # Nacos地址</span></span>
<span class="line"><span>yml</span></span></code></pre></div></li></ul><h4 id="_5-优化" tabindex="-1">5&gt; 优化 <a class="header-anchor" href="#_5-优化" aria-label="Permalink to &quot;5&gt; 优化&quot;">​</a></h4><hr><ul><li><p>实际部署时，需要给做反向代理的nginx服务器设置一个域名，这样后续如果有服务器迁移nacos的客户端也无需更改配置.</p></li><li><p>Nacos的各个节点应该部署到多个不同服务器，做好容灾和隔离</p></li></ul><h2 id="二、feign远程调用" tabindex="-1">二、Feign远程调用 <a class="header-anchor" href="#二、feign远程调用" aria-label="Permalink to &quot;二、Feign远程调用&quot;">​</a></h2><blockquote><p>Feign是一个声明式的http客户端，官方地址：<a href="https://github.com/OpenFeign/feign%EF%BC%8C" target="_blank" rel="noreferrer">https://github.com/OpenFeign/feign，</a><strong>他集成了负载均衡Ribbo</strong>n。</p></blockquote><h2 id="_1-feign解决的问题" tabindex="-1">1.Feign解决的问题 <a class="header-anchor" href="#_1-feign解决的问题" aria-label="Permalink to &quot;1.Feign解决的问题&quot;">​</a></h2><ul><li><p><strong>先来看我们以前利用<code>RestTemplate</code>发起远程调用的代码</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>String url = &quot;http://userservice/user/&quot; + order.getUserId();</span></span>
<span class="line"><span>User user = restTemplate.getForObject(url, User.class);</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p><strong>存在的问题有以下几条</strong></p><ul><li>代码可读性差，编程体验不统一</li><li>参数复杂URL难以维护</li></ul></li></ul><p><strong>而使用Feign能完美的帮我们解决以上的问题，其作用就是帮助我们优雅的实现http请求的发送。</strong></p><h2 id="_2-feign替代resttemplate" tabindex="-1">2.Feign替代RestTemplate <a class="header-anchor" href="#_2-feign替代resttemplate" aria-label="Permalink to &quot;2.Feign替代RestTemplate&quot;">​</a></h2><blockquote><p>使用Feign的大致流程如下：</p></blockquote><ol><li>引入依赖</li><li>添加<code>@EnableFeignClients</code>注解</li><li>编写<code>FeignClient</code>接口</li><li>使用<code>FeignClient</code>中定义的方法代替<code>RestTemplate</code></li></ol><h3 id="_2-1-引入依赖" tabindex="-1">2.1 引入依赖 <a class="header-anchor" href="#_2-1-引入依赖" aria-label="Permalink to &quot;2.1 引入依赖&quot;">​</a></h3><hr><ul><li><p><strong>我们在 <code>order-service</code> 引入 <code>feign</code> 依赖</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li></ul><h3 id="_2-2-添加注解" tabindex="-1">2.2 添加注解 <a class="header-anchor" href="#_2-2-添加注解" aria-label="Permalink to &quot;2.2 添加注解&quot;">​</a></h3><hr><ul><li><p><strong>在 <code>order-service</code> 启动类添加注解开启 Feign（这个时候可以删掉RestTemplate的代码，因为我们不依赖他）</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@MapperScan(&quot;cn.itcast.order.mapper&quot;)</span></span>
<span class="line"><span>@SpringBootApplication</span></span>
<span class="line"><span>@EnableFeignClients //开启feign</span></span>
<span class="line"><span>public class OrderApplication {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static void main(String[] args) {</span></span>
<span class="line"><span>        SpringApplication.run(OrderApplication.class, args);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul><h3 id="_2-4-编写feign的客户端" tabindex="-1">2.4 编写Feign的客户端 <a class="header-anchor" href="#_2-4-编写feign的客户端" aria-label="Permalink to &quot;2.4 编写Feign的客户端&quot;">​</a></h3><hr><ul><li><p><strong>在 <code>order-service</code> 中新建一个接口，内容如下</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.order.client;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import cn.itcast.order.pojo.User;</span></span>
<span class="line"><span>import org.springframework.cloud.openfeign.FeignClient;</span></span>
<span class="line"><span>import org.springframework.web.bind.annotation.GetMapping;</span></span>
<span class="line"><span>import org.springframework.web.bind.annotation.PathVariable;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@FeignClient(&quot;userservice&quot;)</span></span>
<span class="line"><span>public interface UserClient {</span></span>
<span class="line"><span>    @GetMapping(&quot;/user/{id}&quot;)</span></span>
<span class="line"><span>    User fingById(@PathVariable(&quot;id&quot;) Long id);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div><p>这个客户端主要是基于SpringMVC的注解来声明远程调用的信息，比如：</p><ul><li>服务名称：userservice（@FeignClient(“userservice”)）</li><li>请求方式：GET（@GetMapping）</li><li>请求路径：/user/{id}（(“/user/{id}”)）</li><li>请求参数：Long id（@PathVariable(“id”) Long id）</li><li>返回值类型：User（返回值类型）</li></ul><p><strong>这样，Feign就可以帮助我们发送http请求，无需自己使用RestTemplate来发送了。</strong></p></li></ul><h3 id="_2-5-测试" tabindex="-1">2.5 测试 <a class="header-anchor" href="#_2-5-测试" aria-label="Permalink to &quot;2.5 测试&quot;">​</a></h3><hr><ul><li><p><strong>修改<code>order-service</code>中的<code>OrderService</code>类中的<code>queryOrderById</code>方法，使用<code>Feign</code>客户端代替<code>RestTemplate</code></strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@Autowired</span></span>
<span class="line"><span>private UserClient userClient;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>public Order queryOrderById(Long orderId) {</span></span>
<span class="line"><span>    // 1.查询订单</span></span>
<span class="line"><span>    Order order = orderMapper.findById(orderId);</span></span>
<span class="line"><span>    // 2.使用feign实现远程调用</span></span>
<span class="line"><span>    User user = userClient.fingById(order.getUserId());</span></span>
<span class="line"><span>    // 3.将获取到的用户信息封装进order对象</span></span>
<span class="line"><span>    order.setUser(user);</span></span>
<span class="line"><span>    // 4.返回</span></span>
<span class="line"><span>    return order;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul><h2 id="_3-自定义配置" tabindex="-1">3.自定义配置 <a class="header-anchor" href="#_3-自定义配置" aria-label="Permalink to &quot;3.自定义配置&quot;">​</a></h2><blockquote><p>Feign可以支持很多的自定义配置，如下表所示</p></blockquote><table><thead><tr><th>类型</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><strong>feign.Logger.Level</strong></td><td>修改日志级别</td><td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td></tr><tr><td>feign.codec.Decoder</td><td>响应结果的解析器</td><td>http远程调用的结果做解析，例如解析json字符串为java对象</td></tr><tr><td>feign.codec.Encoder</td><td>请求参数编码</td><td>将请求参数编码，便于通过http请求发送</td></tr><tr><td>feign. Contract</td><td>支持的注解格式</td><td>默认是SpringMVC的注解</td></tr><tr><td>feign. Retryer</td><td>失败重试机制</td><td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td></tr></tbody></table><p><strong>一般情况下，默认值就能满足我们使用，如果要自定义时，只需要创建自定义的@Bean覆盖默认Bean即可。</strong></p><p>下面以日志为例来演示如何自定义配置</p><h3 id="_3-1-配置文件方式" tabindex="-1">3.1 配置文件方式 <a class="header-anchor" href="#_3-1-配置文件方式" aria-label="Permalink to &quot;3.1 配置文件方式&quot;">​</a></h3><hr><ul><li><p><strong>基于配置文件修改feign的日志级别可以针对单个服务</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>feign:  </span></span>
<span class="line"><span>  client:</span></span>
<span class="line"><span>    config: </span></span>
<span class="line"><span>      userservice: # 针对某个微服务的配置</span></span>
<span class="line"><span>        loggerLevel: FULL #  日志级别 </span></span>
<span class="line"><span>yml</span></span></code></pre></div></li><li><p><strong>也可以针对所有服务</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>feign:  </span></span>
<span class="line"><span>  client:</span></span>
<span class="line"><span>    config: </span></span>
<span class="line"><span>      default: # 这里用default就是全局配置，如果是写服务名称，则是针对某个微服务的配置</span></span>
<span class="line"><span>        loggerLevel: FULL #  日志级别 </span></span>
<span class="line"><span>yml</span></span></code></pre></div></li><li><p><strong>而日志的级别分为四种</strong>：</p><ul><li>NONE：不记录任何日志信息，这是默认值。</li><li>BASIC：仅记录请求的方法，URL以及响应状态码和执行时间</li><li>HEADERS：在BASIC的基础上，额外记录了请求和响应的头信息</li><li>FULL：记录所有请求和响应的明细，包括头信息、请求体、元数据。</li></ul></li></ul><h3 id="_3-2-java代码方式" tabindex="-1">3.2 Java代码方式 <a class="header-anchor" href="#_3-2-java代码方式" aria-label="Permalink to &quot;3.2 Java代码方式&quot;">​</a></h3><hr><ul><li><p><strong>也可以基于Java代码来修改日志级别，先声明一个类，然后声明一个<code>Logger.Level</code>的对象</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>public class DefaultFeignConfiguration  {</span></span>
<span class="line"><span>    @Bean</span></span>
<span class="line"><span>    public Logger.Level feignLogLevel(){</span></span>
<span class="line"><span>        return Logger.Level.BASIC; // 日志级别为BASIC</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>如果要<strong>全局生效</strong>，将其放到启动类的 <code>@EnableFeignClients</code> 这个注解中</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration .class) </span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>如果是<strong>局部生效</strong>，则把它放到对应的 <code>@FeignClient</code> 这个注解中</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@FeignClient(value = &quot;userservice&quot;, configuration = DefaultFeignConfiguration .class) </span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul><h2 id="_4-feign性能优化" tabindex="-1">4.Feign性能优化 <a class="header-anchor" href="#_4-feign性能优化" aria-label="Permalink to &quot;4.Feign性能优化&quot;">​</a></h2><p>Feign 底层发起 http 请求，依赖于其它的框架。其底层客户端实现有：</p><ul><li><strong>URLConnection</strong>：默认实现，不支持连接池</li><li><strong>Apache HttpClient</strong> ：支持连接池</li><li><strong>OKHttp</strong>：支持连接池</li></ul><p>因此提高 Feign 性能的主要手段就是使用<strong>连接池</strong>代替默认的 URLConnection,另外，日志级别应该尽量用 basic/none，可以有效提高性能。</p><blockquote><p><strong>这里我们用 Apache 的HttpClient来演示连接池。</strong></p></blockquote><ul><li><p><strong>在 <code>order-service</code> 的 <code>pom</code> 文件中引入 <code>HttpClient</code> 依赖</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;!--httpClient的依赖 --&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;feign-httpclient&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li><li><p><strong>在 <code>order-service</code> 的 <code>application.yml</code> 中添加配置</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>feign:</span></span>
<span class="line"><span>  client:</span></span>
<span class="line"><span>    config:</span></span>
<span class="line"><span>      userservice: # 针对某个微服务的配置</span></span>
<span class="line"><span>        loggerLevel: FULL #  日志级别</span></span>
<span class="line"><span>  httpclient:</span></span>
<span class="line"><span>    enabled: true # 开启feign对HttpClient的支持</span></span>
<span class="line"><span>    max-connections: 200 # 最大的连接数</span></span>
<span class="line"><span>    max-connections-per-route: 50 # 每个路径的最大连接数</span></span>
<span class="line"><span>yml</span></span></code></pre></div></li></ul><p><strong>总结，Feign的优化：</strong></p><ol><li><p>日志级别尽量用basic</p></li><li><p>使用HttpClient或OKHttp代替URLConnection</p><ul><li><p>引入feign-httpClient依赖</p></li><li><p>配置文件开启httpClient功能，设置连接池参数</p></li></ul></li></ol><h2 id="_5-feign最佳实践" tabindex="-1">5.Feign最佳实践 <a class="header-anchor" href="#_5-feign最佳实践" aria-label="Permalink to &quot;5.Feign最佳实践&quot;">​</a></h2><blockquote><p>所谓最近实践，就是使用过程中总结的经验，最好的一种使用方式，接下来介绍两种方案。</p></blockquote><h3 id="_5-1-继承方式" tabindex="-1">5.1 继承方式 <a class="header-anchor" href="#_5-1-继承方式" aria-label="Permalink to &quot;5.1 继承方式&quot;">​</a></h3><hr><p><strong>一样的代码可以通过继承来共享</strong>：</p><ul><li>定义一个 API 接口，利用定义方法，并基于 SpringMVC 注解做声明</li><li>Feign 客户端、Controller 都继承该接口</li></ul><p><img src="`+M+'" alt="image-20220530164329834"></p><p><strong>优点</strong></p><ul><li>简单</li><li>实现了代码共享</li></ul><p><strong>缺点</strong></p><ul><li>服务提供方、服务消费方紧耦合</li><li>参数列表中的注解映射并不会继承，因此 Controller 中必须再次声明方法、参数列表、注解</li></ul><h3 id="_5-2-抽取方式" tabindex="-1">5.2 抽取方式 <a class="header-anchor" href="#_5-2-抽取方式" aria-label="Permalink to &quot;5.2 抽取方式&quot;">​</a></h3><hr><blockquote><p>将 FeignClient 抽取为独立模块，并且把接口有关的 pojo、默认的 Feign 配置都放到这个模块中，提供给所有消费者使用。</p><p>例如：将 UserClient、User、Feign 的默认配置都抽取到一个 feign-api 包中，所有微服务引用该依赖包，即可直接使用。</p></blockquote><p><img src="'+U+'" alt="image-20220530164446935"></p><p>接下来我们就用该方法在代码中实现</p><ul><li><p><strong>首先创建一个 <code>module</code>，命名为 <code>feign-api</code></strong></p><p><img src="'+k+`" alt="image-20220530164620291"></p></li><li><p><strong>在 <code>feign-api</code> 中然后引入依赖</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li><li><p><strong>然后，<code>order-service</code>中编写的<code>UserClient</code>、<code>User</code>、<code>DefaultFeignConfiguration</code>都复制到feign-api项目中</strong></p><p><img src="`+y+`" alt="image-20220530165024880"></p></li><li><p><strong>接下来在 <code>order-service</code> 的pom文件中引入 <code>feign-api</code></strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;cn.itcast.demo&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;feign-api&lt;/artifactId&gt;</span></span>
<span class="line"><span>    &lt;version&gt;1.0&lt;/version&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li><li><p><strong>修改 order-service 启动类上的 <code>@EnableFeignClients</code> 注解</strong></p><p>方式一（推荐）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@EnableFeignClients(clients = {UserClient.class})</span></span>
<span class="line"><span>java</span></span></code></pre></div><p>方式二：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@EnableFeignClients(basePackages = &quot;cn.itcast.feign.clients&quot;)</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul><h2 id="三、gateway服务网关" tabindex="-1">三、Gateway服务网关 <a class="header-anchor" href="#三、gateway服务网关" aria-label="Permalink to &quot;三、Gateway服务网关&quot;">​</a></h2><blockquote><p>Spring Cloud Gateway 是 Spring Cloud 的一个全新项目，该项目是基于 Spring 5.0，Spring Boot 2.0 和 Project Reactor 等响应式编程和事件流技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。</p></blockquote><h2 id="_1-为什么需要网关" tabindex="-1">1.为什么需要网关 <a class="header-anchor" href="#_1-为什么需要网关" aria-label="Permalink to &quot;1.为什么需要网关&quot;">​</a></h2><blockquote><p>Gateway网关是我们服务的守门神，所有微服务的统一入口。</p></blockquote><p>网关的<strong>核心功能特性</strong>：</p><ul><li>请求路由</li><li>权限控制</li><li>限流</li></ul><p><img src="`+A+'" alt="image-20220530182615744"></p><p><strong>权限控制</strong>：网关作为微服务入口，需要校验用户是是否有请求资格，如果没有则进行拦截。</p><p><strong>路由和负载均衡</strong>：一切请求都必须先经过gateway，但网关不处理业务，而是根据某种规则，把请求转发到某个微服务，这个过程叫做路由。当然路由的目标服务有多个时，还需要做负载均衡。</p><p><strong>限流</strong>：当请求流量过高时，在网关中按照下流的微服务能够接受的速度来放行请求，避免服务压力过大。</p><p>在SpringCloud中网关的实现包括两种：</p><ul><li>gateway</li><li>zuul</li></ul><p>Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloudGateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能。</p><h2 id="_2-gateway快速入门" tabindex="-1">2.Gateway快速入门 <a class="header-anchor" href="#_2-gateway快速入门" aria-label="Permalink to &quot;2.Gateway快速入门&quot;">​</a></h2><p>下面，我们就演示下网关的基本路由功能。基本步骤如下</p><ol><li>创建 SpringBoot 工程 gateway，引入网关依赖</li><li>编写启动类</li><li>编写基础配置和路由规则</li><li>启动网关服务进行测试</li></ol><h3 id="_2-1-创建工程并引入依赖" tabindex="-1">2.1 创建工程并引入依赖 <a class="header-anchor" href="#_2-1-创建工程并引入依赖" aria-label="Permalink to &quot;2.1 创建工程并引入依赖&quot;">​</a></h3><hr><ul><li><p><strong>创建一个子工程gateway</strong></p><p><img src="'+q+`" alt="image-20220530182926286"></p></li><li><p><strong>引入以下依赖（网关也是一个微服务，因此也需要加入nacos依赖）</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;!--网关--&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>&lt;!--nacos服务发现依赖--&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li></ul><h3 id="_2-2-编写启动类" tabindex="-1">2.2 编写启动类 <a class="header-anchor" href="#_2-2-编写启动类" aria-label="Permalink to &quot;2.2 编写启动类&quot;">​</a></h3><hr><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.gateway;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import org.springframework.boot.SpringApplication;</span></span>
<span class="line"><span>import org.springframework.boot.autoconfigure.SpringBootApplication;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@SpringBootApplication</span></span>
<span class="line"><span>public class GtewayApplication {</span></span>
<span class="line"><span>    public static void main(String[] args) {</span></span>
<span class="line"><span>        SpringApplication.run(GtewayApplication.class,args);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div><h3 id="_2-3-创建application-yml文件" tabindex="-1">2.3 创建application.yml文件 <a class="header-anchor" href="#_2-3-创建application-yml文件" aria-label="Permalink to &quot;2.3 创建application.yml文件&quot;">​</a></h3><hr><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>server:</span></span>
<span class="line"><span>  port: 10010</span></span>
<span class="line"><span>spring:</span></span>
<span class="line"><span>  application:</span></span>
<span class="line"><span>    name: gateway</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    nacos:</span></span>
<span class="line"><span>      server-addr: localhost:8848</span></span>
<span class="line"><span>    gateway:</span></span>
<span class="line"><span>      routes: # 网关路由配置</span></span>
<span class="line"><span>        - id: user-service # 路由id，自定义，只要唯一即可</span></span>
<span class="line"><span>          # uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span></span>
<span class="line"><span>          uri: lb://userservice # 路由的目标地址 lb就是负载均衡，后面跟服务名称</span></span>
<span class="line"><span>          predicates: # 路由断言，也就是判断请求是否符合路由规则的条件</span></span>
<span class="line"><span>            - Path=/user/** # 这个是按照路径匹配，只要以/user/开头就符合要求</span></span>
<span class="line"><span>        - id: order-service </span></span>
<span class="line"><span>          uri: lb://orderservice </span></span>
<span class="line"><span>          predicates:</span></span>
<span class="line"><span>            - Path=/order/**</span></span>
<span class="line"><span>yml</span></span></code></pre></div><p>我们将符合<code>Path</code> 规则的一切请求，都代理到 <code>uri</code>参数指定的地址。</p><p>上面的例子中，我们将 <code>/user/**</code> 开头的请求，代理到 <code>lb://userservice</code>，其中 lb 是负载均衡(LoadBalance)，根据服务名拉取服务列表，实现负载均衡。</p><h3 id="_2-4-重启测试" tabindex="-1">2.4 重启测试 <a class="header-anchor" href="#_2-4-重启测试" aria-label="Permalink to &quot;2.4 重启测试&quot;">​</a></h3><hr><p>重启网关，访问<a href="http://localhost:10010/user/1%E6%97%B6%EF%BC%8C%E7%AC%A6%E5%90%88%60/user/**%60%E8%A7%84%E5%88%99%EF%BC%8C%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91%E5%88%B0uri%EF%BC%9A%5Bhttp://userservice/user/1%EF%BC%8C%E5%BE%97%E5%88%B0%E4%BA%86%E7%BB%93%E6%9E%9C%EF%BC%9A%5D(http://userservice/user/1%EF%BC%8C%E5%BE%97%E5%88%B0%E4%BA%86%E7%BB%93%E6%9E%9C%EF%BC%9A)" target="_blank" rel="noreferrer">http://localhost:10010/user/1时，符合\`/user/**\`规则，请求转发到uri：[http://userservice/user/1，得到了结果：](http://userservice/user/1，得到了结果：)</a></p><p><img src="`+O+'" alt="image-20220530183429549"></p><h3 id="_2-5-网关路由的流程图" tabindex="-1">2.5 网关路由的流程图 <a class="header-anchor" href="#_2-5-网关路由的流程图" aria-label="Permalink to &quot;2.5 网关路由的流程图&quot;">​</a></h3><hr><p><img src="'+F+'" alt="录制_2022_05_30_18_36_22_320"></p><h3 id="_2-6-总结" tabindex="-1">2.6 总结 <a class="header-anchor" href="#_2-6-总结" aria-label="Permalink to &quot;2.6 总结&quot;">​</a></h3><hr><p><strong>网关搭建步骤：</strong></p><ol><li><p>创建项目，引入nacos服务发现和gateway依赖</p></li><li><p>配置application.yml，包括服务基本信息、nacos地址、路由</p></li></ol><p><strong>路由配置包括：</strong></p><ol><li><p>路由id：路由的唯一标示</p></li><li><p>路由目标（uri）：路由的目标地址，http代表固定地址，lb代表根据服务名负载均衡</p></li><li><p>路由断言（predicates）：判断路由的规则，</p></li><li><p>路由过滤器（filters）：对请求或响应做处理</p></li></ol><p>接下来，就重点来学习路由断言和路由过滤器的详细知识</p><h2 id="_3-断言工厂" tabindex="-1">3.断言工厂 <a class="header-anchor" href="#_3-断言工厂" aria-label="Permalink to &quot;3.断言工厂&quot;">​</a></h2><blockquote><p>官方文档：<a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories" target="_blank" rel="noreferrer">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a></p></blockquote><p>我们在配置文件中写的断言规则只是字符串，这些字符串会被 Predicate Factory 读取并处理，转变为路由判断的条件。</p><p>例如 <code>Path=/user/**</code> 是按照路径匹配，这个规则是由<code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code> 类来处理的，像这样的断言工厂在 Spring Cloud Gateway 还有十几个</p><table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>After</td><td>是某个时间点后的请求</td><td>- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td></tr><tr><td>Before</td><td>是某个时间点之前的请求</td><td>- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td></tr><tr><td>Between</td><td>是某两个时间点之前的请求</td><td>- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td></tr><tr><td>Cookie</td><td>请求必须包含某些cookie</td><td>- Cookie=chocolate, ch.p</td></tr><tr><td>Header</td><td>请求必须包含某些header</td><td>- Header=X-Request-Id, \\d+</td></tr><tr><td>Host</td><td>请求必须是访问某个host（域名）</td><td>- Host=<strong>.somehost.org,</strong>.anotherhost.org</td></tr><tr><td>Method</td><td>请求方式必须是指定方式</td><td>- Method=GET,POST</td></tr><tr><td>Path</td><td>请求路径必须符合指定规则</td><td>- Path=/red/{segment},/blue/**</td></tr><tr><td>Query</td><td>请求参数必须包含指定参数</td><td>- Query=name, Jack或者- Query=name</td></tr><tr><td>RemoteAddr</td><td>请求者的ip必须是指定范围</td><td>- RemoteAddr=192.168.1.1/24</td></tr><tr><td>Weight</td><td>权重处理</td><td></td></tr></tbody></table><p><strong>一般的，我们只需要掌握 Path，加上官方文档的例子，就可以应对各种工作场景了。</strong></p><h2 id="_4-过滤器工厂" tabindex="-1">4.过滤器工厂 <a class="header-anchor" href="#_4-过滤器工厂" aria-label="Permalink to &quot;4.过滤器工厂&quot;">​</a></h2><blockquote><p>GatewayFilter 是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理。</p></blockquote><p><img src="'+x+'" alt="image-20220530184057390"></p><h3 id="_4-1-路由过滤器的种类" tabindex="-1">4.1 路由过滤器的种类 <a class="header-anchor" href="#_4-1-路由过滤器的种类" aria-label="Permalink to &quot;4.1 路由过滤器的种类&quot;">​</a></h3><hr><blockquote><p>Spring提供了31种不同的路由过滤器工厂。例如：</p></blockquote><table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>AddRequestHeader</td><td>给当前请求添加一个请求头</td></tr><tr><td>RemoveRequestHeader</td><td>移除请求中的一个请求头</td></tr><tr><td>AddResponseHeader</td><td>给响应结果中添加一个响应头</td></tr><tr><td>RemoveResponseHeader</td><td>从响应结果中移除有一个响应头</td></tr><tr><td>RequestRateLimiter</td><td>限制请求的流量</td></tr></tbody></table><p>官方文档：<a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories" target="_blank" rel="noreferrer">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a></p><h3 id="_4-2-请求头过滤器" tabindex="-1">4.2 请求头过滤器 <a class="header-anchor" href="#_4-2-请求头过滤器" aria-label="Permalink to &quot;4.2 请求头过滤器&quot;">​</a></h3><hr><blockquote><p>下面我们以AddRequestHeader 为例来讲解。</p><p><strong>需求</strong>：给所有进入userservice的请求添加一个请求头：Describe=Vz-Blog is the Best!</p></blockquote><ul><li><p><strong>只需要修改<code>gateway</code>服务的<code>application.yml</code>文件，添加路由过滤即可</strong></p><p><img src="'+I+`" alt="image-20220530185037958"></p></li><li><p><strong>如何验证，我们修改 <code>users-ervice</code> 中<code>UserController</code>的一个方法</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;/{id}&quot;)</span></span>
<span class="line"><span>public User queryById(@PathVariable(&quot;id&quot;) Long id, @RequestHeader(value = &quot;Describe&quot;,required = false) String describe) {</span></span>
<span class="line"><span>    System.out.println(describe);</span></span>
<span class="line"><span>    return userService.queryById(id);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p><strong>访问 <a href="http://localhost:10010/user/1" target="_blank" rel="noreferrer">http://localhost:10010/user/1</a> 后查看控制台打印结果</strong></p><p><img src="`+R+`" alt="image-20220530185323725"></p></li></ul><h3 id="_4-3-默认过滤器" tabindex="-1">4.3 默认过滤器 <a class="header-anchor" href="#_4-3-默认过滤器" aria-label="Permalink to &quot;4.3 默认过滤器&quot;">​</a></h3><hr><blockquote><p>如果要对所有的路由都生效，则可以将过滤器工厂写到default下。格式如下：</p></blockquote><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring:</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    gateway:</span></span>
<span class="line"><span>      routes:</span></span>
<span class="line"><span>      - id: user-service </span></span>
<span class="line"><span>        uri: lb://userservice </span></span>
<span class="line"><span>        predicates: </span></span>
<span class="line"><span>        - Path=/user/**</span></span>
<span class="line"><span>      default-filters: # 默认过滤项</span></span>
<span class="line"><span>      - AddRequestHeader=Describe,Vz-Blog is the Best!</span></span>
<span class="line"><span>yml</span></span></code></pre></div><h3 id="_4-4-总结" tabindex="-1">4.4 总结 <a class="header-anchor" href="#_4-4-总结" aria-label="Permalink to &quot;4.4 总结&quot;">​</a></h3><hr><ul><li><p>过滤器的作用是什么？</p><ul><li><p>对路由的请求或响应做加工处理，比如添加请求头</p></li><li><p>配置在路由下的过滤器只对当前路由的请求生效</p></li></ul></li><li><p><code>defaultFilters</code>的作用是什么？</p><ul><li>对所有路由都生效的过滤器</li></ul></li></ul><h2 id="_5-全局过滤器" tabindex="-1">5.全局过滤器 <a class="header-anchor" href="#_5-全局过滤器" aria-label="Permalink to &quot;5.全局过滤器&quot;">​</a></h2><p>上面介绍的过滤器工厂，网关提供了 31 种，但每一种过滤器的作用都是固定的。<strong>如果我们希望拦截请求，做自己的业务逻辑则没办法实现</strong>。</p><h3 id="_5-1-全局过滤器作用" tabindex="-1">5.1 全局过滤器作用 <a class="header-anchor" href="#_5-1-全局过滤器作用" aria-label="Permalink to &quot;5.1 全局过滤器作用&quot;">​</a></h3><hr><p>全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用一样。区别在于GatewayFilter通过配置定义，处理逻辑是固定的；而GlobalFilter的逻辑需要自己写代码实现。</p><p>定义方式是实现GlobalFilter接口。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>public interface GlobalFilter {</span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     *  处理当前请求，有必要的话通过{@link GatewayFilterChain}将请求交给下一个过滤器处理</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param exchange 请求上下文，里面可以获取Request、Response等信息</span></span>
<span class="line"><span>     * @param chain 用来把请求委托给下一个过滤器 </span></span>
<span class="line"><span>     * @return {@code Mono&lt;Void&gt;} 返回标示当前过滤器业务结束</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div><p>在filter中编写自定义逻辑，可以实现下列功能：</p><ul><li>登录状态判断</li><li>权限校验</li><li>请求限流等</li></ul><h3 id="_5-2-自定义全局过滤器" tabindex="-1">5.2 自定义全局过滤器 <a class="header-anchor" href="#_5-2-自定义全局过滤器" aria-label="Permalink to &quot;5.2 自定义全局过滤器&quot;">​</a></h3><hr><p>需求：定义全局过滤器，拦截请求，判断请求的参数是否满足下面条件：</p><ul><li><p>参数中是否有authorization，</p></li><li><p>authorization参数值是否为admin</p></li></ul><p>如果同时满足则放行，否则拦截</p><p>实现：</p><p>在gateway中定义一个过滤器：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.gateway.filters;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import org.springframework.cloud.gateway.filter.GatewayFilterChain;</span></span>
<span class="line"><span>import org.springframework.cloud.gateway.filter.GlobalFilter;</span></span>
<span class="line"><span>import org.springframework.core.annotation.Order;</span></span>
<span class="line"><span>import org.springframework.http.HttpStatus;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>import org.springframework.web.server.ServerWebExchange;</span></span>
<span class="line"><span>import reactor.core.publisher.Mono;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Order(-1)</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class AuthorizeFilter implements GlobalFilter {</span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {</span></span>
<span class="line"><span>        // 1.获取请求参数</span></span>
<span class="line"><span>        MultiValueMap&lt;String, String&gt; params = exchange.getRequest().getQueryParams();</span></span>
<span class="line"><span>        // 2.获取authorization参数</span></span>
<span class="line"><span>        String auth = params.getFirst(&quot;authorization&quot;);</span></span>
<span class="line"><span>        // 3.校验</span></span>
<span class="line"><span>        if (&quot;admin&quot;.equals(auth)) {</span></span>
<span class="line"><span>            // 放行</span></span>
<span class="line"><span>            return chain.filter(exchange);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        // 4.拦截</span></span>
<span class="line"><span>        // 4.1.禁止访问，设置状态码</span></span>
<span class="line"><span>        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);</span></span>
<span class="line"><span>        // 4.2.结束处理</span></span>
<span class="line"><span>        return exchange.getResponse().setComplete();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div><h3 id="_5-3-过滤器执行顺序" tabindex="-1">5.3 过滤器执行顺序 <a class="header-anchor" href="#_5-3-过滤器执行顺序" aria-label="Permalink to &quot;5.3 过滤器执行顺序&quot;">​</a></h3><hr><p><img src="`+P+`" alt="image-20220530191022084"></p><p>排序的规则是什么呢？</p><ul><li>每一个过滤器都必须指定一个int类型的order值，<strong>order值越小，优先级越高，执行顺序越靠前</strong>。</li><li>GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定</li><li>路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。</li><li>当过滤器的order值一样时，会按照 ==defaultFilter &gt; 路由过滤器 &gt; GlobalFilter的顺序执行==。</li></ul><h2 id="_6-跨域问题" tabindex="-1">6.跨域问题 <a class="header-anchor" href="#_6-跨域问题" aria-label="Permalink to &quot;6.跨域问题&quot;">​</a></h2><p>在gateway服务的application.yml文件中，添加下面的配置：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring:</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    gateway:</span></span>
<span class="line"><span>      # 。。。</span></span>
<span class="line"><span>      globalcors: # 全局的跨域处理</span></span>
<span class="line"><span>        add-to-simple-url-handler-mapping: true # 解决options请求被拦截问题</span></span>
<span class="line"><span>        corsConfigurations:</span></span>
<span class="line"><span>          &#39;[/**]&#39;:</span></span>
<span class="line"><span>            allowedOrigins: # 允许哪些网站的跨域请求 </span></span>
<span class="line"><span>              - &quot;http://localhost:8090&quot;</span></span>
<span class="line"><span>            allowedMethods: # 允许的跨域ajax的请求方式</span></span>
<span class="line"><span>              - &quot;GET&quot;</span></span>
<span class="line"><span>              - &quot;POST&quot;</span></span>
<span class="line"><span>              - &quot;DELETE&quot;</span></span>
<span class="line"><span>              - &quot;PUT&quot;</span></span>
<span class="line"><span>              - &quot;OPTIONS&quot;</span></span>
<span class="line"><span>            allowedHeaders: &quot;*&quot; # 允许在请求中携带的头信息</span></span>
<span class="line"><span>            allowCredentials: true # 是否允许携带cookie</span></span>
<span class="line"><span>            maxAge: 360000 # 这次跨域检测的有效期</span></span>
<span class="line"><span>yml</span></span></code></pre></div>`,216),w=[S];function B(G,j,H,Y,K,z){return n(),s("div",null,w)}const Q=a(D,[["render",B]]);export{V as __pageData,Q as default};
