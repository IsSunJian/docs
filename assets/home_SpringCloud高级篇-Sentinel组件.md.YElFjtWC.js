import{_ as s,c as a,o as e,a4 as n}from"./chunks/framework.-JfgED0h.js";const p="/docs/assets/image-20220719145200027.DaJ37gNl.png",l="/docs/assets/image-20220719145438291.D2__4flg.png",i="/docs/assets/image-20220719145756590.CRf5eKu_.png",t="/docs/assets/image-20220719150145922.BVKj3HEd.png",o="/docs/assets/image-20220719150521628.Bvz1g4Q9.png",c="/docs/assets/image-20220719150600518.YRj5NeeD.png",r="/docs/assets/image-20220719150646510.CAKLY2MY.png",d="/docs/assets/image-20220719150717484.CZyaUQB6.png",g="/docs/assets/image-20220719150821553.D6wm5MRG.png",u="/docs/assets/image-20220719150940620.BoF_-k_n.png",m="/docs/assets/image-20220719151032937.B3_pgRpQ.png",h="/docs/assets/image-20220719151105120.Yri9PK0H.png",A="/docs/assets/2022_07_19_15_44_41_318.E9D6APOb.gif",b="/docs/assets/image-20220719161439329.B17IhYnS.png",q="/docs/assets/image-20220719163045415.ClxVIHJ0.png",C="/docs/assets/image-20220719163121945.R2MhVHzy.png",E="/docs/assets/image-20220719163514535.DdtSFaCE.png",f="/docs/assets/image-20220719163436859.NVKwhmTa.png",k="/docs/assets/image-20220719163639869.BN_kRPaZ.png",v="/docs/assets/image-20220719164647253.wYNSLwZF.png",S="data:image/png;base64,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",_="/docs/assets/image-20220719170757276.DZ0oIfR6.png",B="/docs/assets/image-20220719170845087.Ch7O_ceJ.png",y="/docs/assets/image-20220719171752590.U33NX2UZ.png",x="/docs/assets/image-20220719174348702.smvU_TSw.png",Q="/docs/assets/image-20220719200307434.C5CQo0By.png",w="/docs/assets/image-20220719214124117.BHRCYUQU.png",P="/docs/assets/image-20220719214414292.BDqjYxxi.png",I="/docs/assets/image-20220719214532785.DU1IEhZV.png",D="/docs/assets/image-20220719214717910.P5-7gmn0.png",F="/docs/assets/image-20220719214757714.vJmwa62x.png",J="/docs/assets/image-20220719214815578.H3Zza7SL.png",j="/docs/assets/image-20220720142433487.CNus_Ap8.png",H="/docs/assets/image-20220720143858223.C-1Vui7x.png",O="/docs/assets/image-20220720144102754.Z1KTyT97.png",R="/docs/assets/image-20220720144255498.AJMLkfis.png",M="/docs/assets/image-20220720144456446.Duc13Un6.png",T="/docs/assets/image-20220720144640804.CISwrJ9J.png",z="/docs/assets/image-20220720150741533.CeFlWMsS.png",Y="/docs/assets/image-20220720151717607.C2LSM1SP.png",N="/docs/assets/image-20220720151833107.BlHqGarZ.png",G="/docs/assets/image-20220720152222644.BWBk_W8b.png",U="/docs/assets/image-20220720152350334.DbC7YJQl.png",X="/docs/assets/image-20220720152543116.iFKE__cz.png",K="/docs/assets/image-20220720161434334.D0dpzg5V.png",Z="/docs/assets/image-20220720161614853.DFmyPbEe.png",W="/docs/assets/image-20220720161804100.BbZ9VRhy.png",V="/docs/assets/image-20220720161842034.CfQ1eGx9.png",L="/docs/assets/image-20220720161957300.Cn8nlhl9.png",$="/docs/assets/image-20220720162036886.CNyunZT3.png",ss="/docs/assets/image-20220720162153055.BACePQc1.png",as="/docs/assets/image-20220720162436976.DTt31HAQ.png",es="/docs/assets/image-20220720162507958.QMeaxRVu.png",ns="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAocAAAFICAYAAAAiQlQeAAAOQElEQVR4nO3dPVIbeRrA4VdbPsAcQnLg4gTqEwgnjpx6JpFC2GCyCSfbYFGIkimnRE5AJ0AnoAhQ32H2BtpA8EcwAkvQrf56nipXMWOM2mMDv3nf/uj9ffrrKgAAICI+RET88t+/qj4OAAAq9r9//xb/qvogAACoD3EIAEAiDgEASMQhAABJq+Kw1+tVfQgAAI3Wmjh8CEOBCADwdq2JQwAA3q8Vcfh8Wmh6CADwNq2IQwAAitH4OHxpSmh6CACwv8bHIQAAxRGHAAAkjY7Dn62OrZYBAPbT6DgEAKBY4hAAgKSxcbjrythqGQBgd42NQwAAiteJODQ9BADYTSPjUOwBAJSjkXEIAEA5GheHb50amjYCAPzch6oPYF+r1Wrrv9+Mv5feBwCA1zVucggAQHnEIQAAiTgEACARhwAAJOIQAIBEHAIAkIhDAAAScQgAQCIOAQBIxCEAAIk4BAAgEYcAACTiEACARBwCAJCIQwAAEnEIAEAiDgEASMQhAACJOAQAIBGHAAAk4hAAgGT/OMzzyOfTmE4mkWVZZJNp5Dv/0nlMsix6vd7jjyyLyXS+88cAAKA8H3Z6r3wa2beLWCwWW37y644fIovB6ZZfv1jEbHEcs4txXF2fx2injwYAQBl2mxwubx/DcDiM4Xgc4+Eer5JP49tDGA7P4mq5itVqFavVMpZX4xhGRCxmcTyZ73PsAAAUbLc4HPwey+VyHXTX13F9fh5fjnZ/kfl/TmMRETE8i+X1SYz6Dz/Tj/7oPK6vxut/nP0ZU/tlAIDK7BaH/X70+/2fv99W8/gxW781/Po5tn6U0ZdY5+EiLi7VIQBAVcq/Wjm/i5uIiBjG188vBeYovtwPDxcXly5OAQCoSPlxuLxdr5TjKD6+MnwcfLo/iXFxG8vSDwoAgG1Kj8P87qbslwAAoCC1uQl2/+MeV7gAAFCK2sTho5u4c9IhAEAlahiHr5+bCABAeWoYhwAAVKU2cejCFQCA6pUeh48Xmrx+LuHy9uHxep9iUPZBAQCwVfmTw42nn9y+eAPDPNLg8Ojj9qeoAABQugOslQfxcH/r2Y/59nfJL+PifnA4/jIq/5AAANjqAHHYj5M/7p+NNzuObPpst5zPY/LtdP0UleFZ/K4NAQAqc5gLUkbncfXw7OTTQfR6WWRZFlnWi97gOGbrMoyz7ydWygAAFTrY1cqj82VcnY1jvWFexGKxiMX9KjmG47haXseJMgQAqFTv79NfV7/896/DvmqeR1ou9/uFTAt7vV56e7VaFfARAQC65X///i0+VPLKBQUhAADFqs1NsAEAqJ44BAAgEYcAACTiEACARBwCAJCIQwAAEnEIAEAiDgEASMQhAACJOAQAIBGHAAAk4hAAgEQcAgCQiEMAABJxCABAIg4BAEjEIQAAiTgEACARhwAAJOIQAIBEHAIAkIhDAAAScQgAQCIOAQBIxCEAAIk4BAAgEYcAACTiEACARBwCAJCIQwAAEnEIAEAiDgEASMQhAACJOAQAIBGHAAAk4hAAgEQcAgCQiEMAABJxCABAIg4BAEjEIQAAiTgEACARhwAAJOIQAIBEHAIAkIhDAAAScQgAQCIOAQBIxCEAAIk4BAAgEYcAACTiEACARBwCAJCIQwAAEnEIAEAiDgEASMQhAACJOAQAIBGHAAAk4hAAgEQcAgCQiEMAABJxCABA8qHqA4D36vV6lb32arWq7LUBoAzikNqqMvp29d5jFJcA1I04pHJNiMCyvOX3Liif6vLfH2grX+eqJQ45qDK+kVf5RaSKMHnrazb9i60IBDgMcUip2r52fe/xHTJ4xBUAuxCHFG7fCKl7AJbpLb93kbddl/8eARRJHPJuYvCw3vrfr+lR6e8NwGGIQ95sl9jwDb0+/FkAsAtxyF4EIQC0mzhkJz+LQkEIAO0gDnmRIASA7hGH/IMoBIDuEockr0WhIASAbhCHiEIAIBGHHfdSGIpCAOgmcdhRohAA2EYcdowoBABeIw47ZFsYikIAYJM47ADTQgBgV+Kw5UwLAYB9iMOWMi0EAN5CHLaQaSEA8Fb/qvoAKJYwBADew+SwRZ6HoSgEAPYlDlvAtBAAKIq1csMJQwCgSOKwwYQhAFA0a+WGcn4hAFAGk8MGEoYAQFnEYcMIQwCgTOKwQYQhAFA2cdgQwhAAOARx2ADCEAA4FHFYc8IQADgkcVhjwhAAODRxWFPCEACogjisIWEIAFRFHNaMMAQAqiQOa0QYAgBVE4c1IQwBgDoQhzUgDAGAuhCHAAAk4rBipoYAQJ2IwwoJQwCgbsRhTQhDAKAOxGFFnk8NAQDqQBxWwDoZAKgrcXhgwhAAqDNxWCFhCADUjTg8IOcZAgB1Jw4PxDoZAGgCcVgBYQgA1JU4PIDNqaEwBADqTByWzHmGAECTiMMDMjUEAOpOHJbI1BAAaBpxWBJXJwMATSQOD0AYAgBNIQ5LYJ0MADSVOCyYdTIA0GTisETCEABoGnFYIOtkAKDpxGFJTA0BgCYShwUxNQQA2kAclsDUEABoKnFYAFNDAKAtxGHBTA0BgCYTh++0OTUUhgBA04nDd7BOBgDaRhwWxNQQAGgDcfhGpoYAQBuJwwKYGgIAbSEO38DUEABoK3H4TqaGAECbiMM9mRoCAG0mDt/B1BAAaBtxuAdTQwCg7cThG5kaAgBtJA4BAEjE4Y48QxkA6AJxCABAIg53YGoIAHSFOAQAIBGHP+H2NQBAl4jDPVgpAwBtJw5fYWoIAHSNONyRqSEA0AXi8AWmhgBAF4nDHZgaAgBdIQ4BAEjE4RZWygBAV4nDn7BSBgC6RBw+Y2oIAHSZOHyFqSEA0DXiEACARBxu2FwpmxoCAF0kDgEASMQhAACJOLxnpQwAIA4BANggDsO9DQEAHojDZ6yUAYAuE4cAACSdj0MXogAAPOp8HAIA8EgcAgCQdDoOrZQBAJ7qdBwCAPCUOAQAIOlsHFopAwD8U2fjEACAfxKHAAAknYxDK2UAgO06GYcAAGwnDgEASDoXh1bKAAAv61wcAgDwMnEIAEDSqTi0UgYAeF2n4hAAgNeJQwAAks7E4eZKGQCA7ToTh5ucbwgAsF0n4xAAgO06EYdWygAAu+lEHG6yUgYAeFnn4hAAgJeJQwAAktbHofMNAQB21/o43OR8QwCA13UqDgEAeJ04BAAgaXUcbp5vaKUMAPBzrY5DAAD2Iw4BAEhaG4duYQMAsL/WxuEm5xsCAOymE3EIAMBuxCEAAEkr49D5hgAAb9PKONzkfEMAgN21Pg4jTBIBAHbViTgEAGA3rY7D1WplaggAsIdWxyEAAPspLQ7zfB6TLIter/f4I8tiMp1HXtaLPmNqCACwn1LiMJ9mMRgcx2yxePoTi0XMTo9jkE1iXsYLAwA02MNArUrFx2E+jW+n91E4PIur5SpWq1WsVstYXo1jGBGxmMXxRB4CAGyzuXk9tMLjcP6f01hERAzPYnl9EqP+w8/0oz86j+ur8fofZ3/G9ED7Zfc6BACa6tChWHAczuPHbP3W8Ovn6G97l9GXWOfhIi4uD3X2IQBA8x0iFIuNw/wubiIiYhhfP29Nw4gYxZf74eHi4rL0i1NMDQHg56pcY/I2Zf2ZFRuHy9v1SjmO4uNLbRgRg0/D9RuL21gWegAAAN1TZCgWGof53U2RH+7dTA0BgK55byRWchPs/sejKl4WqBlrLIDyvPVr7IeSjmdHN3GXx8YVzW/z0m/aNxxoDp+vUB8+H7ut4sfnvX5uIgAAh1Xx5BAAgDK89dqLSuKw6AtXVqvVkxG4C1GgGXzeQn34fKyHIlb67/3zK3St/Hihyfpcwpcsbx8er/cpBgW99voRfSt/oQGAzimyg4o953Dj6Se3L97AMI80ODz6uP0pKgDAQRmyNE9Zf2YFX5AyiIf7W89+zLe/S34ZF/eDw/GXUbEvDzSKb0YA+znE182C47AfJ3/cPxtvdhzZ9NluOZ/H5Nvp+ikqw7P4XRsCALzq0P8jXfytbEbncfXw7OTTQfR6WWRZFlnWi97gOGbrMoyz7ydWygAAL6hqs1LKfQ5H58u4OhvHesO8iMViEYv7VXIMx3G1vI4TZQgA8EQdTrcp6VY2/RidnMfo5DwizyMtl/t900IAgBor/z6HghAAoDEqfnweAFCZfB6Th+sCek9/ZNkkpvNXblpMa4lDAOisu7jZvC5gw2Ixi9PjQfSyaUjEbhGHANBZn+OPq2Usl6snF0KslldxNr6/cfHiNL49vzUdrSYOAaCr+v0YjfrRf35xQH8UJ+fXj7emu7g0PewQcQgAbDX68lCHt/HiU3FpHXEIAGw3+HR/z+KbuDM67Izyb2UDsCnPI19exuWP27i4uYk4+hrfzz0xCWppebt+5G0cxUefpJ0hDoHy5dPIvl3EYtslkfH14IcD7Gb+Y7Z+Y/gpBtUeCgdkrQyUb3n7GIbDYQzH43i4EBKoqXwafz604dfPpvsdIg6B8g1+j+Vyub5FxvV1XJ+fx5ejqg8KeFke02+n65Xy8Cy+n0jDLrFWBsrnMZrQKPPJIE7XZRhn350T3DUmhwBAMp9kcTyLiBjG+Oo6DA27x+QQAIiIPOaTwZMwPB9VfUxUQRwCQOflMc02VslLE8Mus1YGgC7L5zF5CMPhOK6EYeeZHAJAR+XzSXw7nqWrkpfXLj5BHAJAJ+XzSQzWJxjG8GwZ18aF3LNWBoAuurtJby5OB9Hr9V7/kU3D45W7QRwCAJBYKwNAB/VPrmN1UvVRUEcmhwAAJOIQAIBEHAIAkIhDAAAScQgAQOJqZaASo/NVrM6rPgoAnjM5BAAgEYcAACTiEACARBwCAJCIQwAAEnEIAEDS+/v011XVBwEAQD38H7nUVEh1QFT5AAAAAElFTkSuQmCC",ps="/docs/assets/image-20220720163115630.CUHuueqk.png",ls="/docs/assets/image-20220720163215677.INBbl4q2.png",is="/docs/assets/image-20220720163434023.DarzXBl2.png",ts="/docs/assets/image-20220720163538899.O-20tHaF.png",os="/docs/assets/image-20220720163653016.BQxUZX32.png",cs="/docs/assets/image-20220720170003133.BxSCaqj9.png",rs="/docs/assets/image-20220720170034136.BJ16to18.png",ds="/docs/assets/image-20220720170142369.uwScRf1s.png",gs="/docs/assets/image-20220720170324265.D4GenuKu.png",us="data:image/png;base64,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",ms="/docs/assets/image-20220720170753879.DlvDHaii.png",hs="/docs/assets/image-20220720170827762.DTeQeI3_.png",As="/docs/assets/image-20220720170907541.B5P1ZX2W.png",bs="/docs/assets/image-20220720171118339.C8_ckglt.png",qs="/docs/assets/image-20220720171208024.Ivd0HXWa.png",Cs="/docs/assets/image-20220720171257211.CViSRbxy.png",Es="/docs/assets/image-20220720195438282.DKpqAzGH.png",fs="/docs/assets/image-20220720195528511.CFA_MTOR.png",ks="/docs/assets/image-20220721105656721.D5QjM_ly.png",vs="/docs/assets/image-20220721110111260.JmN7vnBN.png",Ss="/docs/assets/image-20220721114844801.CJDo6IEe.png",_s="/docs/assets/image-20220721115018051.CbOPyQrx.png",Bs="/docs/assets/image-20220721115412851.CovscVRH.png",ys="/docs/assets/image-20220721115659181.DndvEflf.png",xs="/docs/assets/image-20220721115757103.D_aw7H12.png",Qs="/docs/assets/image-20220721115904381.bDyCz0fg.png",ws="/docs/assets/image-20220721115941013.CyLgFSAW.png",Ps="/docs/assets/image-20220721122629120.Bfx3Tdaq.png",Is="/docs/assets/image-20220721123018870.Ddh8ZClB.png",Ds="/docs/assets/image-20220721123743433.Ck4w-YNL.png",Fs="/docs/assets/image-20220721123849541.CkTAkCyH.png",Js="/docs/assets/image-20220721123938082.Cb0BXPDL.png",js="/docs/assets/image-20220721124024322.D-eJ-VG-.png",Hs="/docs/assets/image-20220721124330930.yrLJiDmF.png",Os="/docs/assets/image-20220721124714188.etKXKltv.png",Rs="/docs/assets/image-20220721140544342.CyKaLJdT.png",Ms="/docs/assets/image-20220721140637040.BdPFdOgP.png",Ts="/docs/assets/image-20220721141049833.VepdOaFu.png",zs="/docs/assets/image-20220721141231593.VnoUnl-R.png",Ys="/docs/assets/image-20220721141600966.BULoAnp_.png",Ns="/docs/assets/image-20220721141638254.BJevArxm.png",Gs="/docs/assets/image-20220721150428330.DjWbuq1C.png",Us="/docs/assets/image-20220721150728989.Cf4o2gpT.png",Xs="/docs/assets/image-20220721151517270.CFCEv7dL.png",Ks="/docs/assets/image-20220721151557538.DqcgYg6g.png",Zs="/docs/assets/image-20220721151740819.DiwL3cI3.png",Ws="/docs/assets/image-20220721151828911.BDFbBUAB.png",Vs="/docs/assets/image-20220721153852665.Dfs8-Zcz.png",Ls="/docs/assets/image-20220721153920131.zZatez3c.png",$s="/docs/assets/image-20220721161652836.C2DGapvW.png",sa="/docs/assets/image-20220721161722235.B9OlptJd.png",ga=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"home/SpringCloud高级篇-Sentinel组件.md","filePath":"home/SpringCloud高级篇-Sentinel组件.md"}'),aa={name:"home/SpringCloud高级篇-Sentinel组件.md"},ea=n('<h2 id="一、jmeter压力测试" tabindex="-1">一、JMeter压力测试 <a class="header-anchor" href="#一、jmeter压力测试" aria-label="Permalink to &quot;一、JMeter压力测试&quot;">​</a></h2><blockquote><p>JMeter 依赖于JDK，所以必须确保当前计算机上已经安装了 JDK，并且配置了环境变量</p></blockquote><h2 id="_1-安装jmeter" tabindex="-1">1.安装JMeter <a class="header-anchor" href="#_1-安装jmeter" aria-label="Permalink to &quot;1.安装JMeter&quot;">​</a></h2><ul><li><p>JMeter下载地址：<a href="https://lanzoux.com/ic61W081wt9a" target="_blank" rel="noreferrer">点我下载</a></p></li><li><p>解压下载好的JMeter压缩包</p><p><img src="'+p+'" alt="image-20220719145200027"></p></li></ul><h2 id="_2-运行jmeter" tabindex="-1">2.运行JMeter <a class="header-anchor" href="#_2-运行jmeter" aria-label="Permalink to &quot;2.运行JMeter&quot;">​</a></h2><ul><li><p>打开<code>bin</code>目录，其中包含启动脚本<br><img src="'+l+'" alt="image-20220719145438291"></p></li><li><p>双击即可运行，但是有两点注意</p><ul><li>启动时速度比较慢，要耐心等待。</li><li>启动后终端（黑窗口）不能关闭，否则 JMeter 也跟着关闭。</li></ul><p><img src="'+i+'" alt="image-20220719145756590"></p></li></ul><h2 id="_3-配置jmeter" tabindex="-1">3.配置JMeter <a class="header-anchor" href="#_3-配置jmeter" aria-label="Permalink to &quot;3.配置JMeter&quot;">​</a></h2><blockquote><p>默认 JMeter 的语言是英文，需要设置</p></blockquote><p><img src="'+t+`" alt="image-20220719150145922"></p><blockquote><p><strong>注意</strong>：上面的配置只能保证本次运行是中文，如果要永久中文，需要修改Jmeter的配置文件</p></blockquote><p>打开Jmeter文件夹，在bin目录中找到 <strong>jmeter.properties</strong>，添加下面配置：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>language=zh_CN</span></span>
<span class="line"><span>properties</span></span></code></pre></div><h2 id="_4-基本使用" tabindex="-1">4.基本使用 <a class="header-anchor" href="#_4-基本使用" aria-label="Permalink to &quot;4.基本使用&quot;">​</a></h2><ul><li><p>在测试计划上点鼠标右键，选择「添加 &gt; 线程（用户） &gt; 线程组」</p><p><img src="`+o+'" alt="image-20220719150521628"></p></li><li><p>在新增的线程组中，填写线程信息</p><p><img src="'+c+'" alt="image-20220719150600518"></p></li><li><p>在线程组这里点鼠标右键，添加 http 请求</p><p><img src="'+r+'" alt="image-20220719150646510"></p></li><li><p>编写取样器内容</p><p><img src="'+d+'" alt="image-20220719150717484"></p></li><li><p>添加监听报告</p><p><img src="'+g+'" alt="image-20220719150821553"></p></li><li><p>汇总报告结果</p><p><img src="'+u+'" alt="image-20220719150940620"></p></li><li><p>添加监听结果树</p><p><img src="'+m+'" alt="image-20220719151032937"></p></li><li><p>察看结果树</p><p><img src="'+h+'" alt="image-20220719151105120"></p></li></ul><h2 id="二、初识sentine" tabindex="-1">二、初识Sentine <a class="header-anchor" href="#二、初识sentine" aria-label="Permalink to &quot;二、初识Sentine&quot;">​</a></h2><h2 id="_1-雪崩问题" tabindex="-1">1.雪崩问题 <a class="header-anchor" href="#_1-雪崩问题" aria-label="Permalink to &quot;1.雪崩问题&quot;">​</a></h2><h3 id="_1-1-触发原因" tabindex="-1">1.1 触发原因 <a class="header-anchor" href="#_1-1-触发原因" aria-label="Permalink to &quot;1.1 触发原因&quot;">​</a></h3><blockquote><p>微服务调用链路中的某个服务故障，引起整个链路中的所有微服务都不可用，这就是雪崩。</p></blockquote><p><img src="'+A+'" alt="录制_2022_07_19_15_44_41_318"></p><h3 id="_1-2-解决方案" tabindex="-1">1.2 解决方案 <a class="header-anchor" href="#_1-2-解决方案" aria-label="Permalink to &quot;1.2 解决方案&quot;">​</a></h3><blockquote><p>解决雪崩问题的常见方式有四种</p></blockquote><ol><li>超时处理</li><li>线程隔离</li><li>降级熔断</li><li>限流</li></ol><p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种<strong>预防</strong>措施。</p><p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种<strong>补救</strong>措施。</p><h3 id="_1-3-超时处理-方案1" tabindex="-1">1.3 超时处理（方案1） <a class="header-anchor" href="#_1-3-超时处理-方案1" aria-label="Permalink to &quot;1.3 超时处理（方案1）&quot;">​</a></h3><blockquote><p>超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待</p></blockquote><p><img src="'+b+'" alt="image-20220719161439329"></p><h3 id="_1-4-线程隔离-方案2" tabindex="-1">1.4 线程隔离（方案2） <a class="header-anchor" href="#_1-4-线程隔离-方案2" aria-label="Permalink to &quot;1.4 线程隔离（方案2）&quot;">​</a></h3><blockquote><p>舱壁模式：限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。</p></blockquote><p><img src="'+q+'" alt="image-20220719163045415"></p><p>仓壁模式来源于船舱的设计：</p><p><img src="'+C+'" alt="image-20220719163121945"></p><p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</p><h3 id="_1-5-熔断降级-方案3" tabindex="-1">1.5 熔断降级（方案3） <a class="header-anchor" href="#_1-5-熔断降级-方案3" aria-label="Permalink to &quot;1.5 熔断降级（方案3）&quot;">​</a></h3><blockquote><p>断路器模式：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p></blockquote><ul><li><p>断路器会统计访问某个服务的请求数量，异常比例：</p><p><img src="'+E+'" alt="image-20220719163514535"></p></li><li><p>当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：</p><p><img src="'+f+'" alt="image-20220719163436859"></p></li></ul><h3 id="_1-6-流量控制-方案4" tabindex="-1">1.6 流量控制（方案4） <a class="header-anchor" href="#_1-6-流量控制-方案4" aria-label="Permalink to &quot;1.6 流量控制（方案4）&quot;">​</a></h3><blockquote><p><strong>流量控制</strong>：限制业务访问的QPS，避免服务因流量的突增而故障。</p></blockquote><p><img src="'+k+'" alt="image-20220719163639869"></p><h3 id="_1-7-总结" tabindex="-1">1.7 总结 <a class="header-anchor" href="#_1-7-总结" aria-label="Permalink to &quot;1.7 总结&quot;">​</a></h3><ul><li>什么是雪崩问题？ <ul><li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</li></ul></li><li>如何避免因瞬间高并发流量而导致服务故障？ <ul><li><strong>流量控制</strong></li></ul></li><li>如何避免因服务故障引起的雪崩问题？ <ul><li><strong>超时处理</strong></li><li><strong>线程隔离</strong></li><li><strong>降级熔断</strong></li></ul></li></ul><blockquote><p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种**<code>预防</code>**措施。</p><p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种**<code>补救</code>**措施。</p></blockquote><h2 id="_2-服务保护技术对比" tabindex="-1">2.服务保护技术对比 <a class="header-anchor" href="#_2-服务保护技术对比" aria-label="Permalink to &quot;2.服务保护技术对比&quot;">​</a></h2><p>在SpringCloud当中支持多种服务保护技术：</p><ul><li><a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noreferrer">Netfix Hystrix</a></li><li><a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noreferrer">Sentinel</a></li><li><a href="https://github.com/resilience4j/resilience4j" target="_blank" rel="noreferrer">Resilience4J</a></li></ul><p>早期比较流行的是<code>Hystrix</code>框架，但目前国内实用最广泛的还是阿里巴巴的<code>Sentinel</code>框架，这里我们做下对比：</p><p><img src="'+v+'" alt="image-20220719164647253"></p><ul><li><p>下载Sentinel：<a href="https://wwz.lanzouy.com/iEIy70829bij" target="_blank" rel="noreferrer">https://wwz.lanzouy.com/iEIy70829bij</a> 密码:1234</p><p><img src="'+S+`" alt="image-20220719170231180"></p></li><li><p>运行Sentinel</p><ul><li><p>将jar包放到任意非中文目录，执行命令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>java -jar sentinel-dashboard-1.8.1.jar</span></span>
<span class="line"><span>sh</span></span></code></pre></div></li><li><p>如果要修改Sentinel的默认<code>端口、账户、密码</code>，可以通过下列配置：</p><table><thead><tr><th><strong>配置项</strong></th><th><strong>默认值</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>server.port</td><td>8080</td><td>服务端口</td></tr><tr><td>sentinel.dashboard.auth.username</td><td>sentinel</td><td>默认用户名</td></tr><tr><td>sentinel.dashboard.auth.password</td><td>sentinel</td><td>默认密码</td></tr></tbody></table></li><li><p>例如，修改端口：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar</span></span>
<span class="line"><span>sh</span></span></code></pre></div></li></ul></li><li><p>访问Sentinel</p><ul><li><p>访问 <a href="http://localhost:8080/" target="_blank" rel="noreferrer">http://localhost:8080</a> 页面，就可以看到 Sentinel 的控制台了。</p><p><img src="`+_+'" alt="image-20220719170757276"></p></li><li><p>需要输入账号和密码，默认都是：<code>sentinel</code></p><p><img src="'+B+'" alt="image-20220719170845087"></p></li></ul></li></ul><h2 id="_4-整合sentinel" tabindex="-1">4.整合Sentinel <a class="header-anchor" href="#_4-整合sentinel" aria-label="Permalink to &quot;4.整合Sentinel&quot;">​</a></h2><blockquote><p>要使用Sentinel肯定要结合微服务，这里我们使用SpringCloud实用篇中的cloud-demo工程。</p></blockquote><p>项目结构如下：</p><p><img src="'+y+`" alt="image-20220719171752590"></p><blockquote><p>我们在 order-service 中整合 Sentinel，并连接 Sentinel 的控制台，步骤如下</p></blockquote><ol><li><p>引入<code>Sentinel</code>依赖</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>&lt;!--sentinel--&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; </span></span>
<span class="line"><span>    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>xml</span></span></code></pre></div></li><li><p>修改<code>application.yml</code>配置文件</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>server:</span></span>
<span class="line"><span>  port: 8088</span></span>
<span class="line"><span>spring:</span></span>
<span class="line"><span>  cloud: </span></span>
<span class="line"><span>    sentinel:</span></span>
<span class="line"><span>      transport:</span></span>
<span class="line"><span>        dashboard: localhost:8080</span></span>
<span class="line"><span>yml</span></span></code></pre></div></li><li><p>访问<code>order-service</code>的任意端点</p><p>打开浏览器，访问 <a href="http://localhost:10010/order/101%EF%BC%8C%E5%A4%9A%E8%AE%BF%E9%97%AE%E5%87%A0%E6%AC%A1%EF%BC%8C%E5%A4%9A%E7%82%B9%E5%87%A0%E6%AC%A1%E5%88%B7%E6%96%B0%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%89%8D%E8%83%BD%E8%A7%A6%E5%8F%91" target="_blank" rel="noreferrer">http://localhost:10010/order/101，多访问几次，多点几次刷新，这样才能触发</a> Sentinel 的监控。</p><p>然后再访问 Sentinel 的控制台，查看效果。</p><p><img src="`+x+'" alt="image-20220719174348702"></p></li></ol><h2 id="三、流量控制" tabindex="-1">三、流量控制 <a class="header-anchor" href="#三、流量控制" aria-label="Permalink to &quot;三、流量控制&quot;">​</a></h2><blockquote><p>雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。</p></blockquote><h2 id="_1-簇点链路" tabindex="-1">1.簇点链路 <a class="header-anchor" href="#_1-簇点链路" aria-label="Permalink to &quot;1.簇点链路&quot;">​</a></h2><p>当请求进入微服务时，首先会访问 DispatcherServlet，然后进入 Controller、Service、Mapper，这样的一个调用链就叫做 <strong>簇点链路</strong>。</p><p><strong>簇点链路中被监控的每一个接口就是一个资源</strong>。默认情况下 Sentinel 会监控 SpringMVC 的每一个端点（Endpoint，也就是 Controller 中的方法），因此 SpringMVC 的每一个端点（Endpoint）就是调用链路中的一个资源。</p><p>例如，我们刚才访问的 order-service 中的 OrderController 中的端点：<code>/order/{orderId}</code></p><p><img src="'+Q+'" alt="image-20220719200307434"></p><p>流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：</p><ul><li>流控：流量控制</li><li>降级：降级熔断</li><li>热点：热点参数限流，是限流的一种</li><li>授权：请求的权限控制</li></ul><h2 id="_2-快速入门" tabindex="-1">2.快速入门 <a class="header-anchor" href="#_2-快速入门" aria-label="Permalink to &quot;2.快速入门&quot;">​</a></h2><h3 id="_2-1-示例" tabindex="-1">2.1 示例 <a class="header-anchor" href="#_2-1-示例" aria-label="Permalink to &quot;2.1 示例&quot;">​</a></h3><ul><li><p>点击资源<code>/order/{orderId}</code>后面的<strong>流控</strong>按钮，就可以弹出表单。</p><ul><li><p>其含义是限制 <code>/order/{orderId}</code>这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。</p><p><img src="'+w+'" alt="image-20220719214124117"></p></li></ul></li></ul><h3 id="_2-2-练习" tabindex="-1">2.2 练习 <a class="header-anchor" href="#_2-2-练习" aria-label="Permalink to &quot;2.2 练习&quot;">​</a></h3><blockquote><p>需求：给 <code>/order/{orderId}</code>这个资源设置流控规则，QPS不能超过 <code>5</code>，然后测试。</p></blockquote><ol><li><p>首先在 <code>sentinel</code> 控制台添加限流规则</p><p><img src="'+P+'" alt="image-20220719214414292"></p></li><li><p>利用 <code>JMeter</code> 测试</p><ul><li><p>20 个用户，2 秒内运行完，这样的话 QPS 就是 10，超过了我们在 sentinel 设置的 5</p><p><img src="'+I+'" alt="image-20220719214532785"></p></li></ul></li><li><p>右键启动测试</p><p><img src="'+D+'" alt="image-20220719214717910"></p></li><li><p>查看 <code>JMeter</code> 结果树</p><p><img src="'+F+'" alt="image-20220719214757714"></p></li><li><p>查看 <code>Sentinel</code> 实时监控</p><p><img src="'+J+'" alt="image-20220719214815578"></p></li></ol><h2 id="_3-流控模式" tabindex="-1">3.流控模式 <a class="header-anchor" href="#_3-流控模式" aria-label="Permalink to &quot;3.流控模式&quot;">​</a></h2><blockquote><p>在添加限流规则时，点击高级选项，可以选择三种流控模式：</p></blockquote><ul><li><code>直接</code>：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式 <ul><li>直接对当前资源限流</li></ul></li><li><code>关联</code>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流 <ul><li>相当于高优先级资源触发阈值，对低优先级资源限流。</li></ul></li><li><code>链路</code>：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流 <ul><li>是针对请求来源的限流</li></ul></li></ul><p><img src="'+j+`" alt="image-20220720142433487"></p><p>Ps：上面快速入门中练习的模式就是<code>直接模式</code>。</p><h3 id="_3-1-关联模式" tabindex="-1">3.1 关联模式 <a class="header-anchor" href="#_3-1-关联模式" aria-label="Permalink to &quot;3.1 关联模式&quot;">​</a></h3><blockquote><p>统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p></blockquote><p>**使用场景：**比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p><p><strong>语法说明</strong>：当<code>/write</code>资源访问量触发阈值时，就会对<code>/read</code>资源限流，避免影响<code>/write</code>资源。</p><p><strong>需求说明</strong>：</p><ul><li><p>在<code>OrderController</code>新建两个端点：<code>/order/query</code>和<code>/order/update</code>，无需实现业务</p></li><li><p>配置流控规则，当<code>/order/ update</code>资源被访问的QPS超过5时，对<code>/order/query</code>请求限流</p></li></ul><ol><li><p>定义<code>/order/query</code>端点，模拟订单查询</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;/query&quot;)</span></span>
<span class="line"><span>public String queryOrder() {</span></span>
<span class="line"><span>    return &quot;查询订单成功&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>定义<code>/order/update</code>端点，模拟订单更新</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;/update&quot;)</span></span>
<span class="line"><span>public String updateOrder() {</span></span>
<span class="line"><span>    return &quot;更新订单成功&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>重启服务，查看 <code>Sentinel</code> 控制台的簇点链路</p><p><img src="`+H+'" alt="image-20220720143858223"></p></li><li><p>配置流控规则</p><ul><li><p>对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询<code>/order/query</code>限流，因此点击它后面的按钮</p><p><img src="'+O+'" alt="image-20220720144102754"></p></li></ul></li><li><p>在Jmeter测试</p><ul><li><p>可以看到 1000 个用户，100 秒，因此 QPS 为10，超过了我们设定的阈值：5</p><p><img src="'+R+'" alt="image-20220720144255498"></p></li><li><p>查看 http 请求，请求的目标是<code>/order/update</code>，这样这个端点就会触发阈值。</p><p><img src="'+M+'" alt="image-20220720144456446"></p></li><li><p>请求的目标是 <code>/order/update</code>，但限流的目标是 <code>/order/query</code>，这就是关联模式；我们在浏览器访问 <code>/order/query</code>。</p><p><img src="'+T+'" alt="image-20220720144640804"></p></li></ul></li></ol><p>总结：满足下面条件可以使用关联模式：</p><ul><li>两个有竞争关系的资源</li><li>一个优先级较高，一个优先级较低</li></ul><h3 id="_3-2-链路模式" tabindex="-1">3.2 链路模式 <a class="header-anchor" href="#_3-2-链路模式" aria-label="Permalink to &quot;3.2 链路模式&quot;">​</a></h3><blockquote><p>只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p></blockquote><p><strong>使用案例：</strong></p><ul><li><p>例如有两条请求链路</p><ul><li>/test1 --&gt; /common</li><li>/test2 --&gt; /common</li></ul></li><li><p>如果只希望统计从<code>/test2</code>进入到<code>/common</code>的请求，则可以这样配置：</p><p><img src="'+z+`" alt="image-20220720150741533"></p></li></ul><p><strong>需求说明：</strong></p><ul><li>有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</li><li>步骤： <ol><li>在<code>OrderService</code>中添加一个<code>queryGoods</code>方法，不用实现业务</li><li>在<code>OrderController</code>中，改造<code>/order/query</code>端点，调用<code>OrderService</code>中的<code>queryGoods</code>方法</li><li>在<code>OrderController</code>中添加一个<code>/order/save</code>的端点，调用<code>OrderService的queryGoods</code>方法</li><li>给<code>queryGoods</code>设置限流规则，从<code>/order/query</code>进入<code>queryGoods</code>的方法限制QPS必须小于2</li></ol></li></ul><p><strong>具体流程：</strong></p><ol><li><p>添加查询商品方法</p><ul><li><p>在<code>order-service</code>服务中，给 <code>OrderService</code> 类添加一个 <code>queryGoods</code> 方法</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>public void queryGoods(){</span></span>
<span class="line"><span>    System.err.println(&quot;查询商品&quot;);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>查询订单时，查询商品</p><ul><li><p>在 <code>order-service</code> 的 <code>OrderController</code> 中，修改 <code>/order/query</code> 端点的业务逻辑</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;query&quot;)</span></span>
<span class="line"><span>public String queryOrder(){</span></span>
<span class="line"><span>    orderService.queryGoods();</span></span>
<span class="line"><span>    System.out.println(&quot;查询订单！&quot;);</span></span>
<span class="line"><span>    return &quot;查询订单成功！&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>新增订单，查询商品</p><ul><li><p>在 <code>order-service</code> 的 <code>OrderController</code> 中，修改 <code>/order/save</code> 端点，模拟新增订单</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;/save&quot;)</span></span>
<span class="line"><span>public String saveOrder() {</span></span>
<span class="line"><span>    // 查询商品</span></span>
<span class="line"><span>    orderService.queryGoods();</span></span>
<span class="line"><span>    // 查询订单</span></span>
<span class="line"><span>    System.out.println(&quot;新增订单&quot;);</span></span>
<span class="line"><span>    return &quot;新增订单成功&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>给查询商品添加资源标记</p><ul><li><p>默认情况下，<code>OrderService</code>中的方法是不被<code>Sentinel</code>监控的，需要我们自己通过注解来标记要监控的方法。</p></li><li><p>给<code>OrderService</code>的<code>queryGoods</code>方法添加<code>@SentinelResource</code>注解：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@SentinelResource(&quot;goods&quot;)</span></span>
<span class="line"><span>public void queryGoods(){</span></span>
<span class="line"><span>    System.err.println(&quot;查询商品&quot;);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>修改配置文件</p><ul><li><p>链路模式中，是对不同来源的两个链路做监控。但是<code>sentinel</code>默认会给进入<code>SpringMVC</code>的所有请求设置同一个root资源，会导致链路模式失效。</p></li><li><p>我们需要关闭这种对SpringMVC的资源聚合，修改<code>order-service</code>服务的<code>application.yml</code>文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring:</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    sentinel:</span></span>
<span class="line"><span>      web-context-unify: false # 关闭context整合</span></span>
<span class="line"><span>yml</span></span></code></pre></div></li></ul></li><li><p>重启服务访问 <code>/order/query</code> 和 <code>/order/save</code></p><p><img src="`+Y+'" alt="image-20220720151717607"></p></li><li><p>添加流控规则</p><ul><li><p>点击 <code>goods</code> 资源后面的流控按钮，在弹出的表单中填写下面信息</p></li><li><p>只统计从<code>/order/query</code>进入<code>/goods</code>的资源，QPS阈值为2，超出则被限流。</p><p><img src="'+N+'" alt="image-20220720151833107"></p></li></ul></li><li><p>Jmeter测试</p><ul><li><p>可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2</p><p><img src="'+G+'" alt="image-20220720152222644"></p></li><li><p>查看访问 <code>/order/save</code> 的 http 请求结果（请求一切正常）</p><p><img src="'+U+'" alt="image-20220720152350334"></p></li><li><p>查看访问 <code>/order/query</code> 的 http 请求结果（每次只有2个通过）</p><p><img src="'+X+'" alt="image-20220720152543116"></p></li></ul></li></ol><h2 id="_4-流控效果" tabindex="-1">4.流控效果 <a class="header-anchor" href="#_4-流控效果" aria-label="Permalink to &quot;4.流控效果&quot;">​</a></h2><p><img src="'+K+'" alt="image-20220720161434334"></p><p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p><ul><li><p><strong>快速失败</strong>：达到阈值后，新的请求会被立即拒绝并抛出<code>FlowException</code>异常。是默认的处理方式。</p></li><li><p><strong>Warm Up</strong>：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</p></li><li><p><strong>排队等待</strong>：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p></li></ul><h3 id="_4-1-warm-up" tabindex="-1">4.1 Warm Up <a class="header-anchor" href="#_4-1-warm-up" aria-label="Permalink to &quot;4.1 Warm Up&quot;">​</a></h3><p>阈值一般是一个微服务能承担的最大 QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将 QPS 跑到最大值，可能导致服务瞬间宕机。</p><p>Warm Up 也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 <code>maxThreshold / coldFactor</code>，持续指定时长后，逐渐提高到 maxThreshold 值。而 coldFactor 的默认值是 3.</p><p>例如，我设置 QPS 的 <code>maxThreshold</code> 为 10，预热时间为 5 秒，那么初始阈值就是 10 / 3 = 3，然后在 5 秒后逐渐增长到 10</p><p><img src="'+Z+'" alt="image-20220720161614853"></p><p><strong>需求说明：</strong></p><ul><li>给 <code>/order/{orderId}</code> 这个资源设置限流，最大 QPS 为 10，利用 <code>Warm Up</code> 效果，预热时长为 5 秒。</li></ul><p><strong>具体流程：</strong></p><ol><li><p>配置流控规则</p><p><img src="'+W+'" alt="image-20220720161804100"></p></li><li><p>JMeter 测试</p><p><img src="'+V+'" alt="image-20220720161842034"></p></li><li><p>查看测试结果</p><ul><li><p>刚刚启动时，大部分请求失败，成功的只有 3 个，说明 QPS 被限定在 3</p><p><img src="'+L+'" alt="image-20220720161957300"></p></li><li><p>随着时间推移，成功比例越来越高</p><p><img src="'+$+'" alt="image-20220720162036886"></p></li><li><p>到 Sentinel 控制台查看实时监控</p><p><img src="'+ss+'" alt="image-20220720162153055"></p></li></ul></li></ol><p>总结：用官方的话讲，该方式主要用于系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过&quot;冷启动&quot;，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮的情况。</p><h3 id="_4-2-排队等待" tabindex="-1">4.2 排队等待 <a class="header-anchor" href="#_4-2-排队等待" aria-label="Permalink to &quot;4.2 排队等待&quot;">​</a></h3><p>当请求超过 QPS 阈值时，「快速失败」和 「Warm Up」会拒绝新的请求并抛出异常。</p><p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。这种方式严格控制了请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。</p><p>例如：QPS = 5，意味着每 200ms 处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过 2000ms 的请求会被拒绝并抛出异常。</p><p>比如现在一下子来了 12 个请求，因为每 200ms 执行一个请求，那么预期等待时长就是：</p><ul><li>第6个请求的<strong>预期等待时长</strong> = 200 * (6 - 1) = 1000ms</li><li>第12个请求的预期等待时长 = 200 * (12-1) = 2200ms</li></ul><p><img src="'+as+'" alt="image-20220720162436976"></p><p>现在，第 1 秒同时接收到 10 个请求，但第 2 秒只有 1 个请求，此时 QPS 的曲线这样的</p><p><img src="'+es+'" alt="image-20220720162507958"></p><p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p><p><img src="'+ns+'" alt="image-20220720162542888"></p><blockquote><p>这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p></blockquote><p><strong>需求说明：</strong></p><ul><li>给 <code>/order/{orderId}</code> 这个资源设置限流，最大 QPS 为 10，利用排队等待的流控效果，超时时长设置为 5s</li></ul><p><strong>具体流程：</strong></p><ol><li><p>添加流控规则</p><p><img src="'+ps+'" alt="image-20220720163115630"></p></li><li><p>Jmeter测试</p><ul><li><p>QPS 为 15，已经超过了我们设定的 10，如果是之前的「<code>快速失败</code>」 、「<code>Warm Up</code>」模式，超出的请求应该会直接报错。</p><p><img src="'+ls+'" alt="image-20220720163215677"></p></li><li><p>但是我们看看队列模式的运行结果</p><p><img src="'+is+'" alt="image-20220720163434023"></p></li><li><p>再去<code>sentinel</code>查看实时监控的QPS曲线</p><p><img src="'+ts+'" alt="image-20220720163538899"></p></li><li><p>QPS 非常平滑，一致保持在 10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p></li><li><p>当队列满了以后，才会有部分请求失败</p><p><img src="'+os+'" alt="image-20220720163653016"></p></li></ul></li></ol><h3 id="_4-3-总结" tabindex="-1">4.3 总结 <a class="header-anchor" href="#_4-3-总结" aria-label="Permalink to &quot;4.3 总结&quot;">​</a></h3><p>流控效果有哪些？</p><ul><li><p>快速失败：QPS超过阈值时，拒绝新的请求</p></li><li><p>warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</p></li><li><p>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</p></li></ul><h2 id="_5-热点参数限流" tabindex="-1">5.热点参数限流 <a class="header-anchor" href="#_5-热点参数限流" aria-label="Permalink to &quot;5.热点参数限流&quot;">​</a></h2><blockquote><p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p></blockquote><h3 id="_5-1-全局参数限流" tabindex="-1">5.1 全局参数限流 <a class="header-anchor" href="#_5-1-全局参数限流" aria-label="Permalink to &quot;5.1 全局参数限流&quot;">​</a></h3><ul><li><p>例如，一个根据 id 查询商品的接口</p><p><img src="'+cs+'" alt="image-20220720170003133"></p></li><li><p>访问<code>/goods/{id}</code>的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p><ul><li><p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p><p><img src="'+rs+'" alt="image-20220720170034136"></p></li></ul></li><li><p>配置示例：</p><ul><li><p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5</p><p><img src="'+ds+'" alt="image-20220720170142369"></p></li></ul></li></ul><h3 id="_5-2-热点参数限流" tabindex="-1">5.2 热点参数限流 <a class="header-anchor" href="#_5-2-热点参数限流" aria-label="Permalink to &quot;5.2 热点参数限流&quot;">​</a></h3><p>假设上面的例子是一个商品查询接口，那么刚才的配置中，对这个接口的所有商品一视同仁，QPS 都限定为 5</p><p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的 QPS 限制与其它商品不一样，高一些。那就需要配置「热点参数限流」的高级选项了。</p><p><img src="'+gs+`" alt="image-20220720170324265"></p><p>结合上一个配置，这里的含义是对 0 号的 long 类型参数限流，每 1 个相同参数的 QPS 不能超过 5，有如下两个例外</p><ul><li>如果参数值是 100，则每 1s 允许的 QPS 为 10</li><li>如果参数值是 101，则每 1s 允许的 QPS 为 15</li></ul><h3 id="_5-3-案例练习" tabindex="-1">5.3 案例练习 <a class="header-anchor" href="#_5-3-案例练习" aria-label="Permalink to &quot;5.3 案例练习&quot;">​</a></h3><p><strong>案例需求</strong>：给 /order/{orderId} 这个资源添加「热点参数限流」，规则如下</p><ul><li>默认的热点参数规则是每 1s 请求量不超过 2</li><li>给 102 这个参数设置例外：每 1s 请求量不超过 4</li><li>给 103 这个参数设置例外：每 1s 请求量不超过 10</li></ul><p><strong>注意事项</strong>：热点参数限流对默认的 SpringMVC 资源无效，需要利用 <code>@SentinelResource</code> 注解标记资源。</p><p><strong>实现步骤：</strong></p><ol><li><p>标记资源</p><ul><li><p>给 <code>order-service</code> 中的 <code>OrderController</code> 中的 <code>/order/{orderId}</code> 资源添加注解</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@GetMapping(&quot;{orderId}&quot;)</span></span>
<span class="line"><span>@SentinelResource(&quot;hot&quot;)</span></span>
<span class="line"><span>public Order queryOrderByUserId(@PathVariable(&quot;orderId&quot;) Long orderId) {</span></span>
<span class="line"><span>    // 根据id查询订单并返回</span></span>
<span class="line"><span>    return orderService.queryOrderById(orderId);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>重启服务</p><ul><li><p>访问<code>/order/{orderId}</code>，可以看到我们标记的 hot 资源出现了</p><p><img src="`+us+'" alt="image-20220720170713081"></p></li><li><p>点击左侧菜单中<strong>热点规则</strong>菜单</p><p><img src="'+ms+'" alt="image-20220720170753879"></p></li><li><p>点击新增，填写表单</p><p><img src="'+hs+'" alt="image-20220720170827762"></p></li></ul></li><li><p>JMeter 测试</p><ul><li><p>这里发起请求的 QPS 为 5，包含 3 个 http 请求</p><p><img src="'+As+'" alt="image-20220720170907541"></p></li><li><p>普通参数，QPS 阈值为 2</p><p><img src="'+bs+'" alt="image-20220720171118339"></p></li><li><p>例外项，QPS 阈值为 4</p><p><img src="'+qs+'" alt="image-20220720171208024"></p></li><li><p>例外项，QPS 阈值为 10</p><p><img src="'+Cs+'" alt="image-20220720171257211"></p></li></ul></li></ol><h2 id="四、隔离和降级" tabindex="-1">四、隔离和降级 <a class="header-anchor" href="#四、隔离和降级" aria-label="Permalink to &quot;四、隔离和降级&quot;">​</a></h2><blockquote><p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</p><p>而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p></blockquote><ul><li><p><strong>线程隔离</strong>：</p><ul><li><p>调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p><p><img src="'+Es+'" alt="image-20220720195438282"></p></li></ul></li><li><p><strong>熔断降级</strong>：</p><ul><li><p>是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p><p><img src="'+fs+`" alt="image-20220720195528511"></p></li></ul></li></ul><p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong>发起远程调用时做线程隔离、或者服务熔断。</p><p>而我们的微服务远程调用都是基于 Feign 来完成的，因此我们需要将 Feign 与 Sentinel 整合，在 Feign 里面实现线程隔离和服务熔断。</p><h2 id="_1-feign整合sentinel" tabindex="-1">1.Feign整合Sentinel <a class="header-anchor" href="#_1-feign整合sentinel" aria-label="Permalink to &quot;1.Feign整合Sentinel&quot;">​</a></h2><blockquote><p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p></blockquote><p><strong>整合步骤：</strong></p><ol><li><p>修改 <code>OrderService</code> 的配置文件，开启<code>Feign</code>的<code>Sentinel</code>功能</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>feign:</span></span>
<span class="line"><span>  sentinel:</span></span>
<span class="line"><span>    enabled: true # 开启feign对sentinel的支持</span></span>
<span class="line"><span>yml</span></span></code></pre></div></li><li><p>编写失败降级逻辑</p><ul><li><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p></li><li><p>给<code>FeignClient</code>编写失败后的降级逻辑</p><ul><li>方式一：<code>FallbackClass</code>，无法对远程调用的异常做处理</li><li><strong>方式二：</strong><code>FallbackFactory</code>，可以对远程调用的异常做处理，我们选择这种</li></ul></li><li><p>这里我们演示<strong>方式二</strong>的失败降级处理</p><ul><li><p><strong>步骤一</strong>：在<code>feing-api</code>项目中定义类，实现<code>FallbackFactory</code>：</p><p><img src="`+ks+`" alt="image-20220721105656721"></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.feign.fallback;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import cn.itcast.feign.client.UserClient;</span></span>
<span class="line"><span>import cn.itcast.feign.pojo.User;</span></span>
<span class="line"><span>import feign.hystrix.FallbackFactory;</span></span>
<span class="line"><span>import lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * @Author Vz</span></span>
<span class="line"><span> * Created with IntelliJ IDEA.</span></span>
<span class="line"><span> * Created on 2022-07-20 19:35</span></span>
<span class="line"><span> * Description：</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>public class UserClientFallBackFactory implements FallbackFactory&lt;UserClient&gt; {</span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public UserClient create(Throwable throwable) {</span></span>
<span class="line"><span>        return new UserClient() {</span></span>
<span class="line"><span>            @Override</span></span>
<span class="line"><span>            public User fingById(Long id) {</span></span>
<span class="line"><span>                log.error(&quot;查询用户异常&quot;,throwable);</span></span>
<span class="line"><span>                return new User();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        };</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p><strong>步骤二</strong>：在 <code>feing-api</code> 项目中的 <code>DefaultFeignConfiguration</code> 类中将 <code>UserClientFallbackFactory</code> 注册为一个Bean</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>@Bean</span></span>
<span class="line"><span>public UserClientFallBackFactory userClientFallBackFactory(){</span></span>
<span class="line"><span>    return new UserClientFallBackFactory();</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p><strong>步骤三</strong>：在<code>feing-api</code>项目中的<code>UserClient</code>接口中使用<code>UserClientFallbackFactory</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.feign.client;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import cn.itcast.feign.fallback.UserClientFallBackFactory;</span></span>
<span class="line"><span>import cn.itcast.feign.pojo.User;</span></span>
<span class="line"><span>import org.springframework.cloud.openfeign.FeignClient;</span></span>
<span class="line"><span>import org.springframework.web.bind.annotation.GetMapping;</span></span>
<span class="line"><span>import org.springframework.web.bind.annotation.PathVariable;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * @Author Vz_Cat</span></span>
<span class="line"><span> * Created with IntelliJ IDEA.</span></span>
<span class="line"><span> * Created on 2022-05-30 14:36</span></span>
<span class="line"><span> * Description：</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@FeignClient(value = &quot;userservice&quot;,fallbackFactory = UserClientFallBackFactory.class)</span></span>
<span class="line"><span>public interface UserClient {</span></span>
<span class="line"><span>    @GetMapping(&quot;/user/{id}&quot;)</span></span>
<span class="line"><span>    User fingById(@PathVariable(&quot;id&quot;) Long id);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>**步骤四：**重启服务查看<code>Sentinel</code>控制台，可以看到新的簇点链路（记得重新访问一次订单接口）</p><p><img src="`+vs+'" alt="image-20220721110111260"></p></li></ul></li></ul></li></ol><p><strong>总结：</strong></p><p>Sentinel支持的雪崩解决方案：</p><ul><li>线程隔离（仓壁模式）</li><li>降级熔断</li></ul><p>Feign整合Sentinel的步骤：</p><ul><li>在application.yml中配置：feign.sentienl.enable=true</li><li>给FeignClient编写FallbackFactory并注册为Bean</li><li>将FallbackFactory配置到FeignClient</li></ul><h2 id="_2-线程隔离-舱壁模式" tabindex="-1">2.线程隔离（舱壁模式） <a class="header-anchor" href="#_2-线程隔离-舱壁模式" aria-label="Permalink to &quot;2.线程隔离（舱壁模式）&quot;">​</a></h2><h3 id="_2-1-线程隔离的实现方式" tabindex="-1">2.1 线程隔离的实现方式 <a class="header-anchor" href="#_2-1-线程隔离的实现方式" aria-label="Permalink to &quot;2.1 线程隔离的实现方式&quot;">​</a></h3><p><strong>线程隔离（舱壁模式）有两种方式实现</strong>：</p><ul><li><p>线程池隔离：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果。</p></li><li><p>**信号量隔离（Sentinel默认采用）：**不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p><p><img src="'+Ss+'" alt="image-20220721114844801"></p></li></ul><p><strong>两者的优缺点</strong>：</p><ul><li><p>线程池隔离：基于线程池模式，有额外开销，但隔离控制更强</p></li><li><p>信号量隔离：基于计数器模式，简单，开销小</p><p><img src="'+_s+'" alt="image-20220721115018051"></p></li></ul><h3 id="_2-2-sentinel的线程隔离" tabindex="-1">2.2 Sentinel的线程隔离 <a class="header-anchor" href="#_2-2-sentinel的线程隔离" aria-label="Permalink to &quot;2.2 Sentinel的线程隔离&quot;">​</a></h3><blockquote><p><strong>Sentinel 使用的是信号量隔离</strong>，而 Hystrix 则两种线程隔离都可以，18 年Hystrix已经停止更新。</p></blockquote><p><strong>用法说明：</strong></p><ul><li><p>在添加限流规则时，可以选择两种阈值类型：</p><ul><li><p>QPS：就是每秒的请求数，在快速入门中已经演示过</p></li><li><p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p><p><img src="'+Bs+'" alt="image-20220721115412851"></p></li></ul></li></ul><p><strong>案例需求</strong>：</p><ul><li>给 <code>order-service</code> 服务中的<code>UserClient</code>的查询用户接口设置流控规则，线程数不能超过 2。然后利用<code>jemeter</code>测试。</li></ul><p><strong>实现步骤：</strong></p><ol><li><p>配置隔离规则</p><ul><li><p>选择 feign 接口后面的流控按钮</p><p><img src="'+ys+'" alt="image-20220721115659181"></p></li><li><p>填写表单</p><p><img src="'+xs+'" alt="image-20220721115757103"></p></li></ul></li><li><p>JMeter 测试</p><ul><li><p>一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。</p><p><img src="'+Qs+'" alt="image-20220721115904381"></p></li><li><p>查看运行结果（发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息）</p><p><img src="'+ws+'" alt="image-20220721115941013"></p></li></ul></li></ol><h2 id="_3-熔断降级" tabindex="-1">3.熔断降级 <a class="header-anchor" href="#_3-熔断降级" aria-label="Permalink to &quot;3.熔断降级&quot;">​</a></h2><blockquote><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p></blockquote><p>断路器控制熔断和放行是通过状态机来完成的，如下图就是一个断路器的状态机</p><p><img src="'+Ps+'" alt="image-20220721122629120"></p><p>状态机包括三个状态</p><ul><li><code>closed</code>： <ul><li>关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。会去判断是否达到熔断条件，这一步我们叫做「熔断策略」，达到该条件则切换到 open 状态，打开断路器。</li></ul></li><li><code>open</code>： <ul><li>打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open 状态 5 秒后会进入 half-open 状态。</li></ul></li><li><code>half-open</code>： <ul><li>半开状态，会一段时间放行一次请求，根据执行结果来判断接下来的操作。 <ul><li>请求成功：则切换到 closed 状态；</li><li>请求失败：则切换到 open 状态。</li></ul></li></ul></li></ul><p>断路器熔断策略有三种：慢调用、异常比例、异常数。</p><h3 id="_3-1-慢调用" tabindex="-1">3.1 慢调用 <a class="header-anchor" href="#_3-1-慢调用" aria-label="Permalink to &quot;3.1 慢调用&quot;">​</a></h3><blockquote><p>业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p></blockquote><p><strong>用法说明：</strong></p><ul><li><p>RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p><p><img src="'+Is+`" alt="image-20220721123018870"></p></li></ul><p><strong>案例需求</strong>：</p><ul><li>给 <code>UserClient</code> 的查询用户接口设置降级规则，慢调用的 RT 阈值为 50ms，统计时间为 1s ，最小请求数量为 5，失败阈值比例为 0.4，熔断时长为 5s；</li></ul><p><strong>实现步骤：</strong></p><ol><li><p>设置慢调用</p><ul><li><p>修改 <code>user-service</code> 中的 <code>/user/{id}</code> 这个接口的业务。通过休眠模拟一个延迟时间。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>public User queryById(Long id) throws InterruptedException {</span></span>
<span class="line"><span>    if (id == 1){</span></span>
<span class="line"><span>        Thread.sleep(60);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return userMapper.findById(id);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>此时，<code>orderId=101</code>的订单，关联的是id为1的用户，调用时长为60ms以上：</p><p><img src="`+Ds+'" alt="image-20220721123743433"></p></li><li><p><code>orderId=102</code>的订单，关联的是id为2的用户，调用时长为非常短</p><p><img src="'+Fs+'" alt="image-20220721123849541"></p></li></ul></li><li><p>设置熔断规则</p><ul><li><p>下面，给feign接口设置降级规则</p><p><img src="'+Js+'" alt="image-20220721123938082"></p><p><img src="'+js+'" alt="image-20220721124024322"></p></li></ul></li><li><p>浏览器进行测试</p><ul><li><p>在浏览器访问：<a href="http://localhost:8088/order/101%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B05%E6%AC%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E8%A7%A6%E5%8F%91%E4%BA%86%E7%86%94%E6%96%AD%EF%BC%8C%E8%AF%B7%E6%B1%82%E6%97%B6%E9%95%BF%E7%BC%A9%E7%9F%AD%E8%87%B3" target="_blank" rel="noreferrer">http://localhost:8088/order/101，快速刷新5次，可以发现触发了熔断，请求时长缩短至</a> 5ms，快速失败了，并且走降级逻辑，返回的 null</p><p><img src="'+Hs+'" alt="image-20220721124330930"></p></li><li><p>此时在浏览器访问：<a href="http://localhost:8088/order/102%EF%BC%8C%E4%B9%9F%E8%A2%AB%E7%86%94%E6%96%AD%E4%BA%86" target="_blank" rel="noreferrer">http://localhost:8088/order/102，也被熔断了</a></p><p><img src="'+Os+'" alt="image-20220721124714188"></p></li></ul></li></ol><h3 id="_3-2-异常比例、异常数" tabindex="-1">3.2 异常比例、异常数 <a class="header-anchor" href="#_3-2-异常比例、异常数" aria-label="Permalink to &quot;3.2 异常比例、异常数&quot;">​</a></h3><blockquote><p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p></blockquote><p><strong>用法说明：</strong></p><ul><li><p>例如，一个异常比例设置：</p><ul><li><p>统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p><p><img src="'+Rs+'" alt="image-20220721140544342"></p></li></ul></li><li><p>一个异常数设置：</p><ul><li><p>统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断</p><p><img src="'+Ms+`" alt="image-20220721140637040"></p></li></ul></li></ul><p><strong>案例需求：</strong></p><ul><li>给 <code>UserClient</code>的查询用户接口设置降级规则，统计时间为1秒，最小请求数量为5，失败阈值比例为0.4，熔断时长为5s</li></ul><p><strong>实现步骤：</strong></p><ol><li><p>设置异常请求</p><ul><li><p>修改 <code>user-service</code> 中的 <code>/user/{id}</code> 这个接口的业务。手动抛出异常，以触发异常比例的熔断，也就是说，id 为 2时，就会触发异常。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>public User queryById(Long id) throws InterruptedException {</span></span>
<span class="line"><span>    if (id == 1){</span></span>
<span class="line"><span>        Thread.sleep(60);</span></span>
<span class="line"><span>    }else if (id == 2){</span></span>
<span class="line"><span>        throw new RuntimeException(&quot;故意抛出异常，触发异常比例熔断！&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return userMapper.findById(id);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>设置熔断规则</p><ul><li><p>给feign接口设置降级规则</p><p><img src="`+Ts+'" alt="image-20220721141049833"></p></li><li><p>在5次请求中，只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断</p><p><img src="'+zs+'" alt="image-20220721141231593"></p></li></ul></li><li><p>测试</p><ul><li><p>在浏览器快速访问：<a href="http://localhost:8088/order/102%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B0" target="_blank" rel="noreferrer">http://localhost:8088/order/102，快速刷新</a> 5 次，触发熔断降级。</p><p><img src="'+Ys+'" alt="image-20220721141600966"></p></li><li><p>此时，我们去访问本应该正常的 103，发现也被降级了</p><p><img src="'+Ns+'" alt="image-20220721141638254"></p></li></ul></li></ol><h2 id="五、授权规则" tabindex="-1">五、授权规则 <a class="header-anchor" href="#五、授权规则" aria-label="Permalink to &quot;五、授权规则&quot;">​</a></h2><h2 id="_1-基本规则" tabindex="-1">1.基本规则 <a class="header-anchor" href="#_1-基本规则" aria-label="Permalink to &quot;1.基本规则&quot;">​</a></h2><ul><li><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p><ul><li><p>白名单：来源（origin）在白名单内的调用者允许访问</p></li><li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p></li></ul></li><li><p>点击左侧菜单的授权，可以看到授权规则：</p><p><img src="'+Gs+'" alt="image-20220721150428330"></p></li><li><p>资源名：就是受保护的资源，例如<code>/order/{orderId}</code></p></li><li><p>流控应用：是来源者的名单，</p><ul><li>如果是勾选白名单，则名单中的来源被许可访问。</li><li>如果是勾选黑名单，则名单中的来源被禁止访问。</li></ul></li></ul><h2 id="_2-案例练习" tabindex="-1">2.案例练习 <a class="header-anchor" href="#_2-案例练习" aria-label="Permalink to &quot;2.案例练习&quot;">​</a></h2><p><strong>需求说明：</strong></p><ul><li>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong></li></ul><p><strong>图示：</strong></p><ul><li><img src="'+Us+`" alt="image-20220721150728989"></li></ul><p><strong>实现步骤：</strong></p><ol><li><p>获取<code>origin</code></p><ul><li><p><code>Sentinel</code>是通过<code>RequestOriginParser</code>这个接口的<code>parseOrigin</code>来获取请求的来源的。</p></li><li><p>这个方法的作用就是从<code>request</code>对象中，获取请求者的<code>origin</code>值并返回。</p></li><li><p>默认情况下，<code>sentinel</code>不管请求者从哪里来，返回值永远是<code>default</code>，也就是说一切请求的来源都被认为是一样的值<code>default</code>。</p></li><li><p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的<code>origin</code></strong>。</p></li><li><p>在<code>order-service</code>服务中，我们定义一个<code>RequestOriginParser</code>的实现类</p></li><li><p>我们会尝试从<code>request-header中</code>获取<code>origin</code>值。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.order.sentinel;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>import org.springframework.util.StringUtils;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import javax.servlet.http.HttpServletRequest;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * @Author Vz</span></span>
<span class="line"><span> * Created with IntelliJ IDEA.</span></span>
<span class="line"><span> * Created on 2022-07-21 14:34</span></span>
<span class="line"><span> * Description：</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class HeaderOriginParser implements RequestOriginParser {</span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public String parseOrigin(HttpServletRequest httpServletRequest) {</span></span>
<span class="line"><span>        // 1.获取请求头</span></span>
<span class="line"><span>        String origin = httpServletRequest.getHeader(&quot;origin&quot;);</span></span>
<span class="line"><span>        // 2.非空校验</span></span>
<span class="line"><span>        if (StringUtils.isEmpty(origin)){</span></span>
<span class="line"><span>            origin = &quot;blank&quot;;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return origin;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>给网关添加请求头</p><ul><li><p>我们必须让<strong>所有从 Gateway 路由到微服务的请求都带上 origin 头</strong>。</p></li><li><p>这个需要利用之前学习的一个 <code>GatewayFilter</code> 来实现，使用 <code>AddRequestHeaderGatewayFilter</code>，修改 <code>Gateway</code> 服务中的 <code>application.yml</code></p></li><li><p>这样，从<code>gateway</code>路由的所有请求都会带上<code>origin</code>头，值为<code>gateway</code>。而从其它地方到达微服务的请求则没有这个头。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>spring:</span></span>
<span class="line"><span>  cloud:</span></span>
<span class="line"><span>    gateway:</span></span>
<span class="line"><span>      default-filters:</span></span>
<span class="line"><span>        - AddRequestHeader=origin,gateway #origin前面不能带空格</span></span>
<span class="line"><span>java</span></span></code></pre></div></li></ul></li><li><p>配置授权规则</p><ul><li><p>接下来，我们添加一个授权规则，放行 <code>origin</code> 值为 <code>gateway</code> 的请求。</p><p><img src="`+Xs+'" alt="image-20220721151517270"></p></li><li><p>配置规则如下</p><p><img src="'+Ks+'" alt="image-20220721151557538"></p></li></ul></li><li><p>浏览器访问测试</p><ul><li><p>直接跳过网关，访问 <code>order-service</code> 服务</p><p><img src="'+Zs+'" alt="image-20220721151740819"></p></li><li><p>通过网关访问</p><p><img src="'+Ws+`" alt="image-20220721151828911"></p></li></ul></li></ol><h2 id="_3-自定义异常结果" tabindex="-1">3.自定义异常结果 <a class="header-anchor" href="#_3-自定义异常结果" aria-label="Permalink to &quot;3.自定义异常结果&quot;">​</a></h2><blockquote><p>默认情况下，发生<code>限流、降级、授权</code>拦截时，都会抛出异常到调用方。异常结果都是<code>flow limmiting</code>（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p></blockquote><h3 id="_3-1-异常类型" tabindex="-1">3.1 异常类型 <a class="header-anchor" href="#_3-1-异常类型" aria-label="Permalink to &quot;3.1 异常类型&quot;">​</a></h3><ul><li><p>如果要自定义异常时的返回结果，需要实现<code>BlockExceptionHandler</code>接口</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>public interface BlockExceptionHandler {</span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>这个方法有三个参数</p><ul><li><code>HttpServletRequest request</code>：request对象</li><li><code>HttpServletResponse response</code>：response对象</li><li><code>BlockException e</code>：被sentinel拦截时抛出的异常</li></ul></li><li><p>这里的 <code>BlockException</code> 包含多个不同的子类</p><table><thead><tr><th><strong>异常</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>FlowException</td><td>限流异常</td></tr><tr><td>ParamFlowException</td><td>热点参数限流的异常</td></tr><tr><td>DegradeException</td><td>降级异常</td></tr><tr><td>AuthorityException</td><td>授权规则异常</td></tr><tr><td>SystemBlockException</td><td>系统规则异常</td></tr></tbody></table></li></ul><h3 id="_3-2-自定义异常处理" tabindex="-1">3.2 自定义异常处理 <a class="header-anchor" href="#_3-2-自定义异常处理" aria-label="Permalink to &quot;3.2 自定义异常处理&quot;">​</a></h3><ul><li><p>在<code>order-service</code>定义一个自定义异常处理类</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light dracula-soft vp-code"><code><span class="line"><span>package cn.itcast.order.sentinel;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;</span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.slots.block.BlockException;</span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;</span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;</span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.slots.block.flow.FlowException;</span></span>
<span class="line"><span>import com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import javax.servlet.http.HttpServletRequest;</span></span>
<span class="line"><span>import javax.servlet.http.HttpServletResponse;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class SentinelExceptionHandler implements BlockExceptionHandler {</span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception {</span></span>
<span class="line"><span>        String msg = &quot;未知异常&quot;;</span></span>
<span class="line"><span>        int status = 429;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (e instanceof FlowException) {</span></span>
<span class="line"><span>            msg = &quot;请求被限流了&quot;;</span></span>
<span class="line"><span>        } else if (e instanceof ParamFlowException) {</span></span>
<span class="line"><span>            msg = &quot;请求被热点参数限流&quot;;</span></span>
<span class="line"><span>        } else if (e instanceof DegradeException) {</span></span>
<span class="line"><span>            msg = &quot;请求被降级了&quot;;</span></span>
<span class="line"><span>        } else if (e instanceof AuthorityException) {</span></span>
<span class="line"><span>            msg = &quot;没有权限访问&quot;;</span></span>
<span class="line"><span>            status = 401;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        response.setContentType(&quot;application/json;charset=utf-8&quot;);</span></span>
<span class="line"><span>        response.setStatus(status);</span></span>
<span class="line"><span>        response.getWriter().println(&quot;{\\&quot;msg\\&quot;: &quot; + msg + &quot;, \\&quot;status\\&quot;: &quot; + status + &quot;}&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>java</span></span></code></pre></div></li><li><p>重启测试，在不同场景下，会返回不同的异常消息.</p><ul><li><p>限流情况下</p><p><img src="`+Vs+'" alt="image-20220721153852665"></p></li><li><p>授权拦截时</p><p><img src="'+Ls+'" alt="image-20220721153920131"></p></li></ul></li></ul><h2 id="_4-规则持久化" tabindex="-1">4.规则持久化 <a class="header-anchor" href="#_4-规则持久化" aria-label="Permalink to &quot;4.规则持久化&quot;">​</a></h2><blockquote><p>现在，<code>sentinel</code>的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p></blockquote><p>规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：</p><ul><li>原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。</li><li>pull模式</li><li>push模式</li></ul><h3 id="_4-1-pull模式" tabindex="-1">4.1 pull模式 <a class="header-anchor" href="#_4-1-pull模式" aria-label="Permalink to &quot;4.1 pull模式&quot;">​</a></h3><p>pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p><p><img src="'+$s+'" alt="image-20220721161652836"></p><h3 id="_4-2-push模式" tabindex="-1">4.2 push模式 <a class="header-anchor" href="#_4-2-push模式" aria-label="Permalink to &quot;4.2 push模式&quot;">​</a></h3><p>push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。</p><p><img src="'+sa+'" alt="image-20220721161722235"></p><p>详细步骤可以参考课前资料的《sentinel规则持久化》</p>',218),na=[ea];function pa(la,ia,ta,oa,ca,ra){return e(),a("div",null,na)}const ua=s(aa,[["render",pa]]);export{ga as __pageData,ua as default};
